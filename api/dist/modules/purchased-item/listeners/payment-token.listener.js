'use strict';const a465_0x5e59=['settingService','286391pKZoOL','SettingService','../../settings/services','subscribe','\x20tokens','performerService','get','bind','findById','HANDLE_PAYMENT_TOKEN','UserService','../../studio/services','UserDto','log','memberCommission','sellerId','length','PERFORMER_COMMISSION','getKeyValue','tipCommission','QueueEventService','handler','@nestjs/common','toResponse','includes','CREATED','SUCCESS','RECEIVED_PAID_TOKEN','__metadata','_id','socketUserService','userService','totalPrice','updateBalance','tipped','getUser','findOne','PerformerService','emitToRoom','SocketUserService','defineProperty','PURCHASE_ITEM_TYPE','1841673zHUQNX','notify','USER','env','../../message/constants','GROUP','privateCallCommission','message_created_conversation_','SETTING_KEYS','717708ITuKrr','1195333nxrOaP','decorate','PRIVATE','../../../kernel/constants','type','PRODUCT','MESSAGE_TYPE','ROLE','getOwnPropertyDescriptor','emitToUsers','../../performer/services','object','studioCommission','__decorate','TIP','PHOTO','PaymentTokenListener','SALE_VIDEO','PERFORMER','../../../kernel','queueEventService','1597826jhKVhd','function','productCommission','../../settings/constants','sourceId','../../../kernel/helpers/string.helper','has\x20tipped\x20','studioId','studioService','STUDIO_COMMISSION','number','840104DCpyGv','videoCommission','../../socket/services/socket-user.service','__esModule','conversationService','serializeConversation','StudioService','PURCHASED_ITEM_SUCCESS_CHANNEL','all','1994886OADYjC','performerCommission','EVENT','metadata'];const a465_0x5050ec=a465_0x257d;(function(_0x17df43,_0xa5e9f0){const _0x1f35e9=a465_0x257d;while(!![]){try{const _0x4694af=parseInt(_0x1f35e9(0x174))+-parseInt(_0x1f35e9(0x15e))+parseInt(_0x1f35e9(0x18d))+parseInt(_0x1f35e9(0x17f))+-parseInt(_0x1f35e9(0x15f))+-parseInt(_0x1f35e9(0x155))+parseInt(_0x1f35e9(0x188));if(_0x4694af===_0xa5e9f0)break;else _0x17df43['push'](_0x17df43['shift']());}catch(_0x3ac0fa){_0x17df43['push'](_0x17df43['shift']());}}}(a465_0x5e59,0xeb78d));var __decorate=this&&this[a465_0x5050ec(0x16c)]||function(_0x4b5927,_0x1fa0da,_0x2557fb,_0x55dfc1){const _0x295904=a465_0x5050ec;var _0x27141f=arguments['length'],_0x34c3ee=_0x27141f<0x3?_0x1fa0da:_0x55dfc1===null?_0x55dfc1=Object[_0x295904(0x167)](_0x1fa0da,_0x2557fb):_0x55dfc1,_0x1e8dda;if(typeof Reflect===_0x295904(0x16a)&&typeof Reflect['decorate']==='function')_0x34c3ee=Reflect[_0x295904(0x160)](_0x4b5927,_0x1fa0da,_0x2557fb,_0x55dfc1);else{for(var _0x30b5f9=_0x4b5927[_0x295904(0x19d)]-0x1;_0x30b5f9>=0x0;_0x30b5f9--)if(_0x1e8dda=_0x4b5927[_0x30b5f9])_0x34c3ee=(_0x27141f<0x3?_0x1e8dda(_0x34c3ee):_0x27141f>0x3?_0x1e8dda(_0x1fa0da,_0x2557fb,_0x34c3ee):_0x1e8dda(_0x1fa0da,_0x2557fb))||_0x34c3ee;}return _0x27141f>0x3&&_0x34c3ee&&Object[_0x295904(0x153)](_0x1fa0da,_0x2557fb,_0x34c3ee),_0x34c3ee;},__metadata=this&&this[a465_0x5050ec(0x147)]||function(_0x4a91a1,_0x146609){const _0x148178=a465_0x5050ec;if(typeof Reflect===_0x148178(0x16a)&&typeof Reflect['metadata']===_0x148178(0x175))return Reflect[_0x148178(0x18b)](_0x4a91a1,_0x146609);};Object[a465_0x5050ec(0x153)](exports,a465_0x5050ec(0x182),{'value':!![]}),exports[a465_0x5050ec(0x16f)]=void 0x0;function a465_0x257d(_0x72ad56,_0x4a4e82){return a465_0x257d=function(_0x5e59e7,_0x257ddf){_0x5e59e7=_0x5e59e7-0x146;let _0x507da8=a465_0x5e59[_0x5e59e7];return _0x507da8;},a465_0x257d(_0x72ad56,_0x4a4e82);}const kernel_1=require(a465_0x5050ec(0x172)),common_1=require(a465_0x5050ec(0x1a3)),services_1=require('../../user/services'),services_2=require(a465_0x5050ec(0x169)),constants_1=require(a465_0x5050ec(0x162)),socket_user_service_1=require(a465_0x5050ec(0x181)),services_3=require(a465_0x5050ec(0x18f)),constants_2=require(a465_0x5050ec(0x159)),constants_3=require(a465_0x5050ec(0x177)),services_4=require(a465_0x5050ec(0x198)),services_5=require('../../message/services'),dtos_1=require('../../user/dtos'),string_helper_1=require(a465_0x5050ec(0x179)),constants_4=require('../constants'),HANDLE_PAYMENT_TOKEN=a465_0x5050ec(0x196),RECEIVED_PAID_TOKEN=a465_0x5050ec(0x146);let PaymentTokenListener=class PaymentTokenListener{constructor(_0x52b7ba,_0x3da8ef,_0x144715,_0x473723,_0x38328d,_0x5679a9,_0x18ec6b,_0x4d294d){const _0x1f52ff=a465_0x5050ec;this[_0x1f52ff(0x14a)]=_0x52b7ba,this[_0x1f52ff(0x192)]=_0x3da8ef,this[_0x1f52ff(0x173)]=_0x144715,this[_0x1f52ff(0x149)]=_0x473723,this[_0x1f52ff(0x18c)]=_0x38328d,this[_0x1f52ff(0x189)]=_0x5679a9,this[_0x1f52ff(0x17c)]=_0x18ec6b,this[_0x1f52ff(0x183)]=_0x4d294d,this[_0x1f52ff(0x173)][_0x1f52ff(0x190)](constants_4[_0x1f52ff(0x186)],HANDLE_PAYMENT_TOKEN,this[_0x1f52ff(0x1a2)][_0x1f52ff(0x194)](this));}async['handler'](_0x4ac68f){const _0x1aae30=a465_0x5050ec,{eventName:_0x518e34}=_0x4ac68f,_0x2e2571=_0x4ac68f['data'],{sourceId:_0x3c16b4,source:_0x31d4c6,status:_0x342b37,totalPrice:_0x329fc7}=_0x2e2571,_0x370135=_0x2e2571[_0x1aae30(0x19c)];try{if(_0x518e34!==constants_1[_0x1aae30(0x18a)][_0x1aae30(0x1a6)]||_0x342b37!==constants_4['PURCHASE_ITEM_STATUS'][_0x1aae30(0x1a7)])return;const [_0x480ac7,_0x1fdae0]=await Promise[_0x1aae30(0x187)]([this[_0x1aae30(0x14e)](_0x31d4c6,_0x3c16b4),_0x370135?await this[_0x1aae30(0x192)][_0x1aae30(0x195)](_0x370135):null]);if(!_0x480ac7||!_0x1fdae0)return;let _0xf0e4df=0x0,_0x546c78=0x0;const [_0x261d1e,_0x25fccc,_0x5675dd]=await Promise[_0x1aae30(0x187)]([this[_0x1aae30(0x18c)][_0x1aae30(0x193)](constants_3['SETTING_KEYS'][_0x1aae30(0x19e)]),this[_0x1aae30(0x18c)][_0x1aae30(0x19f)](constants_3[_0x1aae30(0x15d)][_0x1aae30(0x17d)]),this[_0x1aae30(0x189)][_0x1aae30(0x14f)]({'performerId':_0x1fdae0[_0x1aae30(0x148)]})]);if(_0x1fdae0[_0x1aae30(0x17b)])_0x546c78=_0x5675dd&&typeof _0x5675dd[_0x1aae30(0x16b)]===_0x1aae30(0x17e)?_0x5675dd[_0x1aae30(0x16b)]:_0x25fccc,_0xf0e4df=_0x5675dd&&typeof _0x5675dd[_0x1aae30(0x19b)]===_0x1aae30(0x17e)?_0x5675dd[_0x1aae30(0x19b)]:parseInt(process[_0x1aae30(0x158)]['COMMISSION_RATE'],0xa);else{if(_0x5675dd)switch(_0x2e2571['type']){case constants_4[_0x1aae30(0x154)][_0x1aae30(0x15a)]:_0xf0e4df=_0x5675dd['groupCallCommission'];break;case constants_4['PURCHASE_ITEM_TYPE'][_0x1aae30(0x161)]:_0xf0e4df=_0x5675dd[_0x1aae30(0x15b)];break;case constants_4[_0x1aae30(0x154)]['TIP']:_0xf0e4df=_0x5675dd[_0x1aae30(0x1a0)];break;case constants_4[_0x1aae30(0x154)][_0x1aae30(0x164)]:_0xf0e4df=_0x5675dd[_0x1aae30(0x176)];break;case constants_4['PURCHASE_ITEM_TYPE'][_0x1aae30(0x16e)]:_0xf0e4df=_0x5675dd['albumCommission'];break;case constants_4['PURCHASE_ITEM_TYPE'][_0x1aae30(0x170)]:_0xf0e4df=_0x5675dd[_0x1aae30(0x180)];break;default:break;}else _0xf0e4df=_0x261d1e['getValue']();}const _0x39ab6c=_0x1fdae0['studioId']?_0x2e2571['totalPrice']*(_0x546c78/0x64):_0x2e2571[_0x1aae30(0x14b)],_0xb607d8=_0x39ab6c*(_0xf0e4df/0x64);await Promise['all']([this[_0x1aae30(0x192)][_0x1aae30(0x14c)](_0x1fdae0['_id'],_0xb607d8),_0x1fdae0[_0x1aae30(0x17b)]&&this['studioService'][_0x1aae30(0x14c)](_0x1fdae0[_0x1aae30(0x17b)],_0x329fc7*_0x546c78/0x64),_0x31d4c6===constants_1[_0x1aae30(0x166)][_0x1aae30(0x157)]?this['userService'][_0x1aae30(0x14c)](_0x2e2571[_0x1aae30(0x178)],_0x329fc7*-0x1):this[_0x1aae30(0x192)][_0x1aae30(0x14c)](_0x2e2571['sourceId'],_0x329fc7*-0x1)]),await this[_0x1aae30(0x156)](_0x2e2571,_0xb607d8);}catch(_0x2e361e){console[_0x1aae30(0x19a)](_0x2e361e);}}async[a465_0x5050ec(0x156)](_0x493b4e,_0x144dd6){const _0x1c709f=a465_0x5050ec;try{const {targetId:_0x397a49,sourceId:_0x25dc18,type:_0x16af14,totalPrice:_0xb2af65}=_0x493b4e,_0x382303=_0x493b4e[_0x1c709f(0x19c)];if(_0x16af14===constants_4[_0x1c709f(0x154)][_0x1c709f(0x16d)]){const [_0xc34f8b,_0x1f1e69]=await Promise[_0x1c709f(0x187)]([this[_0x1c709f(0x14a)][_0x1c709f(0x195)](_0x25dc18),_0x397a49&&this['conversationService'][_0x1c709f(0x195)](_0x397a49)]),_0x1845ae=_0xc34f8b&&new dtos_1[(_0x1c709f(0x199))](_0xc34f8b)[_0x1c709f(0x1a4)](),_0x26aa36={'conversationId':_0x1f1e69[_0x1c709f(0x148)],'_id':string_helper_1['generateUuid'](),'senderInfo':_0x1845ae,'token':_0xb2af65,'text':_0x1c709f(0x17a)+_0xb2af65+_0x1c709f(0x191),'type':constants_2[_0x1c709f(0x165)][_0x1c709f(0x16d)]};await Promise['all']([_0x1f1e69&&this['socketUserService'][_0x1c709f(0x151)](this[_0x1c709f(0x183)][_0x1c709f(0x184)](_0x1f1e69[_0x1c709f(0x148)],_0x1f1e69[_0x1c709f(0x163)]),_0x1c709f(0x15c)+_0x1f1e69[_0x1c709f(0x148)],_0x26aa36),this[_0x1c709f(0x149)][_0x1c709f(0x168)](_0x382303,_0x1c709f(0x14d),{'senderInfo':_0x1845ae,'token':_0x144dd6})]);}[constants_4[_0x1c709f(0x154)][_0x1c709f(0x15a)],constants_4[_0x1c709f(0x154)][_0x1c709f(0x161)]][_0x1c709f(0x1a5)](_0x16af14)&&this[_0x1c709f(0x149)]['emitToUsers'](_0x382303,RECEIVED_PAID_TOKEN,{'conversationId':_0x397a49,'token':_0x144dd6});}catch(_0x4657c6){console[_0x1c709f(0x19a)](_0x4657c6);}}async[a465_0x5050ec(0x14e)](_0x35c5e0,_0x46f9e9){const _0x5b5250=a465_0x5050ec;if(!_0x35c5e0||!_0x46f9e9)return null;let _0x3f22d9=null;if(_0x35c5e0===constants_1['ROLE'][_0x5b5250(0x157)])_0x3f22d9=await this[_0x5b5250(0x14a)][_0x5b5250(0x195)](_0x46f9e9);else _0x35c5e0===constants_1[_0x5b5250(0x166)][_0x5b5250(0x171)]&&(_0x3f22d9=await this[_0x5b5250(0x192)][_0x5b5250(0x195)](_0x46f9e9));return _0x3f22d9;}};PaymentTokenListener=__decorate([common_1['Injectable'](),__metadata('design:paramtypes',[services_1[a465_0x5050ec(0x197)],services_2[a465_0x5050ec(0x150)],kernel_1[a465_0x5050ec(0x1a1)],socket_user_service_1[a465_0x5050ec(0x152)],services_3[a465_0x5050ec(0x18e)],services_2['PerformerCommissionService'],services_4[a465_0x5050ec(0x185)],services_5['ConversationService']])],PaymentTokenListener),exports[a465_0x5050ec(0x16f)]=PaymentTokenListener;