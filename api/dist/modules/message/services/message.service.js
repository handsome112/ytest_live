'use strict';const a240_0x5e80=['userService','all','getAllFollowerIdsByPerformerId','_id','imageUrl','updatedAt','toResponse','mongoose','5646VKYsNn','findByIds','MESSAGE_PRIVATE_STREAM_CHANNEL','remove','toString','createPrivateConversation','MessageDto','CREATED','File\x20is\x20valid!','../../performer/services','senderId','messageModel','../../user/dtos','limit','QueueEventService','findOne','sort','MessageService','defineProperty','isImage','18INQxcM','queueEventService','performerService','EntityNotFoundException','forwardRef','roles','Inject','skip','fileService','../constants','decorate','conversationService','find','9UUEUtg','senderInfo','sendMessageToAllFollowers','checkBlockByPerformerId','favouriteService','object','conversationId','MESSAGE_EVENT','__esModule','MESSAGE_MODEL_PROVIDER','admin','function','design:paramtypes','deleteAllMessageInConversation','getUrl','source','5870ATxvfw','2183wahQIr','MESSAGE_CHANNEL','loadPublicMessages','../../favourite/services','performer','lean','sortBy','length','./conversation.service','226661jFbqcd','fileId','offset','loadMessages','48077YUDmoO','PerformerService','includes','__decorate','user','Model','create','createPublicStreamMessageFromConversation','findById','41rRdnIC','assign','getOwnPropertyDescriptor','deleteMany','save','@nestjs/common','createPrivateMessageFromConversation','performerBlockSettingService','PerformerDto','publish','123449KzRcaP','ForbiddenException','DELETED','3691czhpiS','../../performer/dtos','filter','../../user/services','countDocuments','../../../kernel','__param','recipients','map','metadata','photo','13mUeqny','UserService','createPrivateFileMessage','ConversationService','Injectable','46mMcjKK','../dtos','PerformerBlockSettingService','sourceId'];const a240_0x3c92f5=a240_0x323b;(function(_0x35d73e,_0x538ff0){const _0x4aac86=a240_0x323b;while(!![]){try{const _0x561eaa=-parseInt(_0x4aac86(0xfc))*-parseInt(_0x4aac86(0x14f))+parseInt(_0x4aac86(0x11c))+parseInt(_0x4aac86(0x15c))*-parseInt(_0x4aac86(0x109))+parseInt(_0x4aac86(0x12f))*parseInt(_0x4aac86(0x13b))+parseInt(_0x4aac86(0x16c))*-parseInt(_0x4aac86(0x12a))+parseInt(_0x4aac86(0x105))+-parseInt(_0x4aac86(0x112))*-parseInt(_0x4aac86(0x11f));if(_0x561eaa===_0x538ff0)break;else _0x35d73e['push'](_0x35d73e['shift']());}catch(_0x1f9a47){_0x35d73e['push'](_0x35d73e['shift']());}}}(a240_0x5e80,0x47278));var __decorate=this&&this[a240_0x3c92f5(0x10c)]||function(_0x5c7493,_0x4f5373,_0x396798,_0x2ac296){const _0x594822=a240_0x3c92f5;var _0x22126d=arguments[_0x594822(0x103)],_0x572840=_0x22126d<0x3?_0x4f5373:_0x2ac296===null?_0x2ac296=Object[_0x594822(0x114)](_0x4f5373,_0x396798):_0x2ac296,_0xee8b7e;if(typeof Reflect===_0x594822(0x161)&&typeof Reflect[_0x594822(0x159)]===_0x594822(0x167))_0x572840=Reflect['decorate'](_0x5c7493,_0x4f5373,_0x396798,_0x2ac296);else{for(var _0x2b2a69=_0x5c7493[_0x594822(0x103)]-0x1;_0x2b2a69>=0x0;_0x2b2a69--)if(_0xee8b7e=_0x5c7493[_0x2b2a69])_0x572840=(_0x22126d<0x3?_0xee8b7e(_0x572840):_0x22126d>0x3?_0xee8b7e(_0x4f5373,_0x396798,_0x572840):_0xee8b7e(_0x4f5373,_0x396798))||_0x572840;}return _0x22126d>0x3&&_0x572840&&Object[_0x594822(0x14d)](_0x4f5373,_0x396798,_0x572840),_0x572840;},__metadata=this&&this['__metadata']||function(_0x4ea1a2,_0x5edda9){const _0x496350=a240_0x3c92f5;if(typeof Reflect===_0x496350(0x161)&&typeof Reflect[_0x496350(0x128)]===_0x496350(0x167))return Reflect[_0x496350(0x128)](_0x4ea1a2,_0x5edda9);},__param=this&&this[a240_0x3c92f5(0x125)]||function(_0x11facc,_0x5e4156){return function(_0x850f6,_0x39194e){_0x5e4156(_0x850f6,_0x39194e,_0x11facc);};};Object[a240_0x3c92f5(0x14d)](exports,a240_0x3c92f5(0x164),{'value':!![]}),exports['MessageService']=void 0x0;const common_1=require(a240_0x3c92f5(0x117)),mongoose_1=require(a240_0x3c92f5(0x13a)),kernel_1=require(a240_0x3c92f5(0x124)),dtos_1=require(a240_0x3c92f5(0x147)),file_1=require('../../file'),services_1=require('../../file/services'),services_2=require(a240_0x3c92f5(0x122)),services_3=require(a240_0x3c92f5(0x144)),services_4=require(a240_0x3c92f5(0xff)),dtos_2=require(a240_0x3c92f5(0x120)),message_provider_1=require('../providers/message.provider'),constants_1=require(a240_0x3c92f5(0x158)),dtos_3=require(a240_0x3c92f5(0x130)),conversation_service_1=require(a240_0x3c92f5(0x104));function a240_0x323b(_0x4587ee,_0x2af135){return a240_0x323b=function(_0x5e8073,_0x323b4d){_0x5e8073=_0x5e8073-0xfc;let _0x18f3d7=a240_0x5e80[_0x5e8073];return _0x18f3d7;},a240_0x323b(_0x4587ee,_0x2af135);}let MessageService=class MessageService{constructor(_0x18c768,_0x1e9f1f,_0x3da969,_0x1763c0,_0x77ac69,_0x375b8e,_0x4c95a9,_0x3fe2cd){const _0x5b490a=a240_0x3c92f5;this[_0x5b490a(0x151)]=_0x18c768,this[_0x5b490a(0x15a)]=_0x1e9f1f,this[_0x5b490a(0x146)]=_0x3da969,this[_0x5b490a(0x150)]=_0x1763c0,this[_0x5b490a(0x157)]=_0x77ac69,this[_0x5b490a(0x133)]=_0x375b8e,this['favouriteService']=_0x4c95a9,this[_0x5b490a(0x119)]=_0x3fe2cd;}async['createStreamMessageFromConversation'](_0xcbdd9e,_0x14696f,_0x22706e,_0x49d248){const _0x168e23=a240_0x3c92f5,_0x51e60f=await this[_0x168e23(0x15a)][_0x168e23(0x111)](_0xcbdd9e);if(!_0x51e60f)throw new kernel_1[(_0x168e23(0x152))]();const _0x274cfb=_0x51e60f[_0x168e23(0x126)][_0x168e23(0x15b)](_0x4b7dad=>_0x4b7dad[_0x168e23(0x132)][_0x168e23(0x13f)]()===_0x22706e['sourceId'][_0x168e23(0x13f)]());if(!_0x274cfb)throw new kernel_1[(_0x168e23(0x152))]();if(_0x22706e[_0x168e23(0x16b)]==='user'){const {performerId:_0xa6cf7a}=_0x51e60f,_0xb1010c=await this[_0x168e23(0x119)][_0x168e23(0x15f)](_0xa6cf7a,_0x22706e[_0x168e23(0x132)],_0x49d248);if(_0xb1010c)throw new common_1[(_0x168e23(0x11d))]();}const _0x2ef953=await this[_0x168e23(0x146)][_0x168e23(0x10f)](Object[_0x168e23(0x113)](Object[_0x168e23(0x113)]({},_0x14696f),{'senderId':_0x22706e['sourceId'],'senderSource':_0x22706e[_0x168e23(0x16b)],'conversationId':_0x51e60f[_0x168e23(0x136)]}));await _0x2ef953[_0x168e23(0x116)]();const _0x43fe6f=new dtos_3[(_0x168e23(0x141))](_0x2ef953);return await this[_0x168e23(0x150)][_0x168e23(0x11b)]({'channel':constants_1[_0x168e23(0x13d)],'eventName':constants_1[_0x168e23(0x163)][_0x168e23(0x142)],'data':_0x43fe6f}),_0x43fe6f;}async[a240_0x3c92f5(0x110)](_0x1d3726,_0x14239e,_0x2caee8,_0x38fa5b,_0xf173d0){const _0x5e4f7a=a240_0x3c92f5,_0x4e1a37=await this[_0x5e4f7a(0x15a)]['findById'](_0x1d3726);if(!_0x4e1a37)throw new kernel_1[(_0x5e4f7a(0x152))]();if(_0x2caee8['source']===_0x5e4f7a(0x10d)){const {performerId:_0xd58039}=_0x4e1a37,_0x3b2fe9=await this[_0x5e4f7a(0x119)][_0x5e4f7a(0x15f)](_0xd58039,_0x2caee8[_0x5e4f7a(0x132)],_0xf173d0);if(_0x3b2fe9)throw new common_1[(_0x5e4f7a(0x11d))]();}const _0x204824=await this[_0x5e4f7a(0x146)]['create'](Object[_0x5e4f7a(0x113)](Object[_0x5e4f7a(0x113)]({},_0x14239e),{'senderId':_0x2caee8['sourceId'],'senderSource':_0x2caee8[_0x5e4f7a(0x16b)],'conversationId':_0x4e1a37[_0x5e4f7a(0x136)]}));await _0x204824['save']();const _0x22fdea=new dtos_3[(_0x5e4f7a(0x141))](_0x204824);return _0x22fdea[_0x5e4f7a(0x15d)]=_0x38fa5b['toResponse'](),await this[_0x5e4f7a(0x150)]['publish']({'channel':constants_1[_0x5e4f7a(0x13d)],'eventName':constants_1[_0x5e4f7a(0x163)][_0x5e4f7a(0x142)],'data':_0x22fdea}),_0x22fdea;}async[a240_0x3c92f5(0x12c)](_0x22ce6b,_0x423a0c,_0x35af09,_0x50bbbf,_0x2e7ae9){const _0x5d0c9b=a240_0x3c92f5,_0x2414c7=await this[_0x5d0c9b(0x15a)][_0x5d0c9b(0x140)](_0x22ce6b,_0x423a0c);if(!_0x35af09)throw new Error(_0x5d0c9b(0x143));if(!_0x35af09[_0x5d0c9b(0x14e)]()){await this[_0x5d0c9b(0x157)]['removeIfNotHaveRef'](_0x35af09[_0x5d0c9b(0x136)]);throw new Error('Invalid\x20image!');}if(_0x22ce6b[_0x5d0c9b(0x16b)]===_0x5d0c9b(0x10d)){const {performerId:_0x3a6292}=_0x2414c7,_0x2e42a2=await this[_0x5d0c9b(0x119)]['checkBlockByPerformerId'](_0x3a6292,_0x22ce6b[_0x5d0c9b(0x132)],_0x2e7ae9);if(_0x2e42a2)throw new common_1[(_0x5d0c9b(0x11d))]();}const _0x50280c=await this[_0x5d0c9b(0x146)][_0x5d0c9b(0x10f)](Object[_0x5d0c9b(0x113)](Object['assign']({},_0x50bbbf),{'type':_0x5d0c9b(0x129),'senderId':_0x22ce6b['sourceId'],'fileId':_0x35af09[_0x5d0c9b(0x136)],'senderSource':_0x22ce6b[_0x5d0c9b(0x16b)],'conversationId':_0x2414c7['_id']}));await _0x50280c[_0x5d0c9b(0x116)]();const _0x4ccff5=new dtos_3[(_0x5d0c9b(0x141))](_0x50280c);return _0x4ccff5[_0x5d0c9b(0x137)]=_0x35af09[_0x5d0c9b(0x16a)](),await this[_0x5d0c9b(0x150)][_0x5d0c9b(0x11b)]({'channel':constants_1[_0x5d0c9b(0xfd)],'eventName':constants_1['MESSAGE_EVENT'][_0x5d0c9b(0x142)],'data':_0x4ccff5}),_0x4ccff5;}async[a240_0x3c92f5(0x108)](_0x367848,_0x272ab8){const _0x5cd8e3=a240_0x3c92f5,_0x18dcf7=await this[_0x5cd8e3(0x15a)]['findById'](_0x367848[_0x5cd8e3(0x162)]);if(!_0x18dcf7)throw new kernel_1[(_0x5cd8e3(0x152))]();const _0x2bf3f1=_0x18dcf7[_0x5cd8e3(0x126)][_0x5cd8e3(0x15b)](_0x2c0253=>_0x2c0253['sourceId'][_0x5cd8e3(0x13f)]()===_0x272ab8[_0x5cd8e3(0x136)][_0x5cd8e3(0x13f)]());if(!_0x2bf3f1)throw new kernel_1[(_0x5cd8e3(0x152))]();const _0x25d2e5={'conversationId':_0x18dcf7[_0x5cd8e3(0x136)]},_0x594de5={[_0x367848[_0x5cd8e3(0x102)]||_0x5cd8e3(0x138)]:_0x367848[_0x5cd8e3(0x14b)]},[_0x24a0c7,_0x95af38]=await Promise['all']([this[_0x5cd8e3(0x146)][_0x5cd8e3(0x15b)](_0x25d2e5)['sort'](_0x594de5)[_0x5cd8e3(0x101)]()[_0x5cd8e3(0x148)](parseInt(_0x367848[_0x5cd8e3(0x148)],0xa))[_0x5cd8e3(0x156)](parseInt(_0x367848[_0x5cd8e3(0x107)],0xa)),this[_0x5cd8e3(0x146)]['countDocuments'](_0x25d2e5)]),_0x2bd4dc=_0x24a0c7[_0x5cd8e3(0x127)](_0x4a734b=>_0x4a734b['fileId']),_0x2469da=await this[_0x5cd8e3(0x157)][_0x5cd8e3(0x13c)](_0x2bd4dc),_0x5e321f=_0x24a0c7[_0x5cd8e3(0x127)](_0x14c917=>{const _0x2843d8=_0x5cd8e3;if(_0x14c917[_0x2843d8(0x106)]){const _0x559942=_0x2469da[_0x2843d8(0x15b)](_0x3e3bd7=>_0x3e3bd7[_0x2843d8(0x136)][_0x2843d8(0x13f)]()===_0x14c917[_0x2843d8(0x106)][_0x2843d8(0x13f)]());return Object[_0x2843d8(0x113)](Object[_0x2843d8(0x113)]({},_0x14c917),{'imageUrl':_0x559942&&_0x559942[_0x2843d8(0x16a)]()});}return Object[_0x2843d8(0x113)]({},_0x14c917);});return{'data':_0x5e321f['map'](_0x563c9b=>new dtos_3['MessageDto'](_0x563c9b)),'total':_0x95af38};}async[a240_0x3c92f5(0xfe)](_0x2478d5){const _0x198373=a240_0x3c92f5,_0x4fa277=await this[_0x198373(0x15a)][_0x198373(0x111)](_0x2478d5[_0x198373(0x162)]);if(!_0x4fa277)throw new kernel_1[(_0x198373(0x152))]();const _0xc7e86b={[_0x2478d5['sortBy']||'updatedAt']:_0x2478d5[_0x198373(0x14b)]},_0x4b718d={'conversationId':_0x4fa277[_0x198373(0x136)]},[_0x1f6760,_0x18834b]=await Promise[_0x198373(0x134)]([this[_0x198373(0x146)][_0x198373(0x15b)](_0x4b718d)['sort'](_0xc7e86b)[_0x198373(0x101)]()['limit'](parseInt(_0x2478d5[_0x198373(0x148)],0xa))[_0x198373(0x156)](parseInt(_0x2478d5[_0x198373(0x107)],0xa)),this['messageModel'][_0x198373(0x123)](_0x4b718d)]),_0x11ad8a=_0x1f6760['map'](_0x13d1ee=>_0x13d1ee[_0x198373(0x145)]),[_0x4265c6,_0x30a1e1]=await Promise[_0x198373(0x134)]([_0x11ad8a['length']?this[_0x198373(0x133)][_0x198373(0x13c)](_0x11ad8a):[],_0x11ad8a['length']?this[_0x198373(0x151)][_0x198373(0x13c)](_0x11ad8a):[]]),_0x4f1efa=_0x1f6760[_0x198373(0x127)](_0x169848=>{const _0x349bb7=_0x198373;let _0x20148f=null;return _0x20148f=_0x4265c6[_0x349bb7(0x15b)](_0x54e272=>_0x54e272['_id'][_0x349bb7(0x13f)]()===_0x169848[_0x349bb7(0x145)][_0x349bb7(0x13f)]()),!_0x20148f&&(_0x20148f=_0x30a1e1[_0x349bb7(0x15b)](_0x3662b1=>_0x3662b1[_0x349bb7(0x136)]['toString']()===_0x169848[_0x349bb7(0x145)][_0x349bb7(0x13f)]())),Object[_0x349bb7(0x113)](Object[_0x349bb7(0x113)]({},_0x169848),{'senderInfo':_0x20148f&&_0x20148f[_0x349bb7(0x154)]&&_0x20148f['roles']['includes'](_0x349bb7(0x10d))?new dtos_1['UserDto'](_0x20148f)[_0x349bb7(0x139)]():new dtos_2[(_0x349bb7(0x11a))](_0x20148f)['toResponse']()});});return{'data':_0x4f1efa[_0x198373(0x127)](_0xf2e909=>new dtos_3[(_0x198373(0x141))](_0xf2e909)),'total':_0x18834b};}async[a240_0x3c92f5(0x118)](_0x402db4,_0x3d1d83,_0x561efb,_0x542952){const _0x39a194=a240_0x3c92f5,_0x276d5a=await this[_0x39a194(0x15a)][_0x39a194(0x111)](_0x402db4);if(!_0x276d5a)throw new kernel_1[(_0x39a194(0x152))]();const _0x3b3ac5=_0x276d5a[_0x39a194(0x126)][_0x39a194(0x15b)](_0x5ab8e9=>_0x5ab8e9[_0x39a194(0x132)]['toString']()===_0x561efb['sourceId']['toString']());if(!_0x3b3ac5)throw new kernel_1['EntityNotFoundException']();if(_0x561efb[_0x39a194(0x16b)]===_0x39a194(0x10d)){const {performerId:_0x14f648}=_0x276d5a,_0x7b1ed4=await this[_0x39a194(0x119)][_0x39a194(0x15f)](_0x14f648,_0x561efb[_0x39a194(0x132)],_0x542952);if(_0x7b1ed4)throw new common_1[(_0x39a194(0x11d))]();}const _0x4ca579=await this[_0x39a194(0x146)][_0x39a194(0x10f)](Object[_0x39a194(0x113)](Object[_0x39a194(0x113)]({},_0x3d1d83),{'senderId':_0x561efb['sourceId'],'senderSource':_0x561efb[_0x39a194(0x16b)],'conversationId':_0x276d5a['_id']}));await _0x4ca579['save']();const _0x4b3c66=new dtos_3[(_0x39a194(0x141))](_0x4ca579);return await this['queueEventService'][_0x39a194(0x11b)]({'channel':constants_1[_0x39a194(0xfd)],'eventName':constants_1[_0x39a194(0x163)][_0x39a194(0x142)],'data':_0x4b3c66}),_0x4b3c66;}async[a240_0x3c92f5(0x15e)](_0x18bc32,_0x484b8d){const _0x1701ec=a240_0x3c92f5,_0x58bcef=await this[_0x1701ec(0x160)][_0x1701ec(0x135)](_0x18bc32);if(!_0x58bcef['length'])return![];const _0x6c69ec={'source':_0x1701ec(0x100),'sourceId':_0x18bc32},_0x27fe27=await Promise[_0x1701ec(0x134)](_0x58bcef[_0x1701ec(0x127)](_0x1e1b03=>this[_0x1701ec(0x15a)][_0x1701ec(0x14a)]({'type':constants_1['CONVERSATION_TYPE']['PRIVATE'],'recipients':{'$all':[{'source':_0x1701ec(0x10d),'sourceId':_0x1e1b03},_0x6c69ec]}}))),_0x4ed760=_0x58bcef[_0x1701ec(0x121)]((_0x933c62,_0x1cc597)=>!_0x27fe27[_0x1cc597]),_0xdc36ea=await Promise[_0x1701ec(0x134)](_0x4ed760['map'](_0x426207=>this[_0x1701ec(0x15a)][_0x1701ec(0x140)]({'sourceId':_0x18bc32,'source':'performer'},{'sourceId':_0x426207,'source':_0x1701ec(0x10d)})));return await Promise['all']([..._0xdc36ea,..._0x27fe27][_0x1701ec(0x127)](_0x3b6d4e=>_0x3b6d4e&&this[_0x1701ec(0x118)](_0x3b6d4e[_0x1701ec(0x136)],_0x484b8d,_0x6c69ec))),!![];}async['deleteMessage'](_0x3061b9,_0x3c9ebb){const _0x3a483f=a240_0x3c92f5,_0x6bf1d=await this[_0x3a483f(0x146)][_0x3a483f(0x111)](_0x3061b9);if(!_0x6bf1d)throw new kernel_1[(_0x3a483f(0x152))]();if(_0x3c9ebb[_0x3a483f(0x154)]&&!_0x3c9ebb[_0x3a483f(0x154)][_0x3a483f(0x10b)](_0x3a483f(0x166))&&_0x6bf1d[_0x3a483f(0x145)][_0x3a483f(0x13f)]()!==_0x3c9ebb[_0x3a483f(0x136)][_0x3a483f(0x13f)]())throw new common_1[(_0x3a483f(0x11d))]();return await _0x6bf1d[_0x3a483f(0x13e)](),await this[_0x3a483f(0x150)][_0x3a483f(0x11b)]({'channel':constants_1['MESSAGE_PRIVATE_STREAM_CHANNEL'],'eventName':constants_1[_0x3a483f(0x163)][_0x3a483f(0x11e)],'data':new dtos_3[(_0x3a483f(0x141))](_0x6bf1d)}),_0x6bf1d;}async[a240_0x3c92f5(0x169)](_0x5f1abe,_0x3668aa){const _0x386cb7=a240_0x3c92f5,_0x1495da=await this[_0x386cb7(0x15a)]['findById'](_0x5f1abe);if(!_0x1495da)throw new kernel_1[(_0x386cb7(0x152))]();if(_0x3668aa['roles']&&!_0x3668aa[_0x386cb7(0x154)]['includes'](_0x386cb7(0x166))&&_0x1495da['performerId']['toString']()!==_0x3668aa[_0x386cb7(0x136)][_0x386cb7(0x13f)]())throw new common_1[(_0x386cb7(0x11d))]();return await this[_0x386cb7(0x146)][_0x386cb7(0x115)]({'conversationId':_0x1495da[_0x386cb7(0x136)]}),{'success':!![]};}};MessageService=__decorate([common_1[a240_0x3c92f5(0x12e)](),__param(0x0,common_1[a240_0x3c92f5(0x155)](common_1[a240_0x3c92f5(0x153)](()=>services_3[a240_0x3c92f5(0x10a)]))),__param(0x2,common_1[a240_0x3c92f5(0x155)](message_provider_1[a240_0x3c92f5(0x165)])),__param(0x4,common_1[a240_0x3c92f5(0x155)](common_1[a240_0x3c92f5(0x153)](()=>services_1['FileService']))),__metadata(a240_0x3c92f5(0x168),[services_3[a240_0x3c92f5(0x10a)],conversation_service_1[a240_0x3c92f5(0x12d)],mongoose_1[a240_0x3c92f5(0x10e)],kernel_1[a240_0x3c92f5(0x149)],services_1['FileService'],services_2[a240_0x3c92f5(0x12b)],services_4['FavouriteService'],services_3[a240_0x3c92f5(0x131)]])],MessageService),exports[a240_0x3c92f5(0x14c)]=MessageService;