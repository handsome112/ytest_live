'use strict';const a241_0x5d0e=['../../user/dtos','decorate','NotificationMessageService','totalNotReadMessage','conversationService','aggregate','length','mongoose','findById','emitToUsers','recipientReadAllMessageInConversation','toString','total','237OlLHjR','design:paramtypes','2xdXCvJ','@nestjs/common','getOwnPropertyDescriptor','../../../kernel','Inject','__metadata','../providers','countTotalNotReadMessage','1128707FvmmnG','Injectable','NOTIFICATION_MESSAGE_MODEL_PROVIDER','metadata','85542SLfqRJ','349042bWqsop','13dHwpNo','socketUserService','function','967011vRXUaI','./conversation.service','_id','notificationMessageModel','3057jpeoEp','$totalNotReadMessage','recipients','500394mdYifq','../../socket/services/socket-user.service','1765743KDVjsn','defineProperty','object','sourceId','find'];const a241_0x7aa34f=a241_0x5c1d;function a241_0x5c1d(_0x2ce004,_0x1bdcc0){return a241_0x5c1d=function(_0x5d0ee8,_0x5c1dfc){_0x5d0ee8=_0x5d0ee8-0x17d;let _0x27c0e4=a241_0x5d0e[_0x5d0ee8];return _0x27c0e4;},a241_0x5c1d(_0x2ce004,_0x1bdcc0);}(function(_0x4f0e6b,_0x4d398f){const _0x39e0ec=a241_0x5c1d;while(!![]){try{const _0x2cbc8f=-parseInt(_0x39e0ec(0x1a7))+parseInt(_0x39e0ec(0x17d))+parseInt(_0x39e0ec(0x184))*parseInt(_0x39e0ec(0x19a))+-parseInt(_0x39e0ec(0x1a6))*parseInt(_0x39e0ec(0x1a8))+parseInt(_0x39e0ec(0x1a2))+-parseInt(_0x39e0ec(0x181))*-parseInt(_0x39e0ec(0x198))+-parseInt(_0x39e0ec(0x186));if(_0x2cbc8f===_0x4d398f)break;else _0x4f0e6b['push'](_0x4f0e6b['shift']());}catch(_0xe0ff82){_0x4f0e6b['push'](_0x4f0e6b['shift']());}}}(a241_0x5d0e,0x91108));var __decorate=this&&this['__decorate']||function(_0x4c48f9,_0x43fb4d,_0x10a787,_0x3f1ac1){const _0x490156=a241_0x5c1d;var _0xab8067=arguments[_0x490156(0x191)],_0x3c9284=_0xab8067<0x3?_0x43fb4d:_0x3f1ac1===null?_0x3f1ac1=Object[_0x490156(0x19c)](_0x43fb4d,_0x10a787):_0x3f1ac1,_0x59baf1;if(typeof Reflect===_0x490156(0x188)&&typeof Reflect['decorate']===_0x490156(0x1aa))_0x3c9284=Reflect[_0x490156(0x18c)](_0x4c48f9,_0x43fb4d,_0x10a787,_0x3f1ac1);else{for(var _0x402336=_0x4c48f9['length']-0x1;_0x402336>=0x0;_0x402336--)if(_0x59baf1=_0x4c48f9[_0x402336])_0x3c9284=(_0xab8067<0x3?_0x59baf1(_0x3c9284):_0xab8067>0x3?_0x59baf1(_0x43fb4d,_0x10a787,_0x3c9284):_0x59baf1(_0x43fb4d,_0x10a787))||_0x3c9284;}return _0xab8067>0x3&&_0x3c9284&&Object[_0x490156(0x187)](_0x43fb4d,_0x10a787,_0x3c9284),_0x3c9284;},__metadata=this&&this[a241_0x7aa34f(0x19f)]||function(_0x5987a3,_0x311dfd){const _0x464a52=a241_0x7aa34f;if(typeof Reflect==='object'&&typeof Reflect[_0x464a52(0x1a5)]===_0x464a52(0x1aa))return Reflect[_0x464a52(0x1a5)](_0x5987a3,_0x311dfd);},__param=this&&this['__param']||function(_0x43446c,_0x33283c){return function(_0x2aa1c5,_0x4d298a){_0x33283c(_0x2aa1c5,_0x4d298a,_0x43446c);};};Object[a241_0x7aa34f(0x187)](exports,'__esModule',{'value':!![]}),exports[a241_0x7aa34f(0x18d)]=void 0x0;const common_1=require(a241_0x7aa34f(0x19b)),mongoose_1=require(a241_0x7aa34f(0x192)),kernel_1=require(a241_0x7aa34f(0x19d)),dtos_1=require(a241_0x7aa34f(0x18b)),socket_user_service_1=require(a241_0x7aa34f(0x185)),conversation_service_1=require(a241_0x7aa34f(0x17e)),providers_1=require(a241_0x7aa34f(0x1a0));let NotificationMessageService=class NotificationMessageService{constructor(_0x3dd229,_0x3590d9,_0x29110e){const _0x5eed0f=a241_0x7aa34f;this['notificationMessageModel']=_0x3dd229,this[_0x5eed0f(0x18f)]=_0x3590d9,this[_0x5eed0f(0x1a9)]=_0x29110e;}async[a241_0x7aa34f(0x195)](_0x5aa7da,_0x2989a4){const _0xeedd20=a241_0x7aa34f,_0x2f7cf6=await this['conversationService'][_0xeedd20(0x193)](_0x2989a4);if(!_0x2f7cf6)throw new kernel_1['EntityNotFoundException']();const _0x2a795d=_0x2f7cf6[_0xeedd20(0x183)][_0xeedd20(0x18a)](_0x4acd4c=>_0x4acd4c[_0xeedd20(0x189)][_0xeedd20(0x196)]()===_0x5aa7da[_0xeedd20(0x196)]());if(!_0x2a795d)throw new kernel_1['EntityNotFoundException']();const _0x10de59=await this[_0xeedd20(0x180)]['findOne']({'recipientId':_0x5aa7da,'conversationId':_0x2989a4});if(!_0x10de59)return{'ok':![]};_0x10de59[_0xeedd20(0x18e)]=0x0,await _0x10de59['save']();const _0x41351f=await this['notificationMessageModel'][_0xeedd20(0x190)]([{'$match':{'recipientId':_0x5aa7da}},{'$group':{'_id':'$conversationId','total':{'$sum':_0xeedd20(0x182)}}}]);let _0x4b17e7=0x0;return _0x41351f&&_0x41351f[_0xeedd20(0x191)]&&_0x41351f['forEach'](_0x482a1e=>{const _0x3c9633=_0xeedd20;_0x482a1e[_0x3c9633(0x197)]&&(_0x4b17e7+=_0x482a1e[_0x3c9633(0x197)]);}),this['socketUserService'][_0xeedd20(0x194)]([_0x5aa7da],'nofify_read_messages_in_conversation',{'total':_0x4b17e7}),{'ok':!![]};}async[a241_0x7aa34f(0x1a1)](_0x305244){const _0x59582b=a241_0x7aa34f,_0x2dcfd0=await this[_0x59582b(0x180)][_0x59582b(0x190)]([{'$match':{'recipientId':_0x305244[_0x59582b(0x17f)]}},{'$group':{'_id':'$conversationId','total':{'$sum':_0x59582b(0x182)}}}]);let _0x5429dc=0x0;if(!_0x2dcfd0||!_0x2dcfd0[_0x59582b(0x191)])return{'total':_0x5429dc};return _0x2dcfd0['forEach'](_0x239dd2=>{const _0x280216=_0x59582b;_0x239dd2[_0x280216(0x197)]&&(_0x5429dc+=_0x239dd2[_0x280216(0x197)]);}),{'total':_0x5429dc};}};NotificationMessageService=__decorate([common_1[a241_0x7aa34f(0x1a3)](),__param(0x0,common_1[a241_0x7aa34f(0x19e)](providers_1[a241_0x7aa34f(0x1a4)])),__metadata(a241_0x7aa34f(0x199),[mongoose_1['Model'],conversation_service_1['ConversationService'],socket_user_service_1['SocketUserService']])],NotificationMessageService),exports[a241_0x7aa34f(0x18d)]=NotificationMessageService;