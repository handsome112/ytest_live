'use strict';const a216_0x4a2b=['updateLastMessage','NotificationMessageModel','CREATED','../constants','GROUP','find','updateNotification','conversationModel','657625ICmndV','filter','message_created','map','$conversationId','forEach','recipients','SocketUserService','bind','__decorate','__esModule','handleMessage','aggregate','senderId','data','566393FRFAaQ','QueueEventService','function','lean','../providers','_id','769844BfHKZV','MessageListener','31iGRYCh','MESSAGE_NOTIFY','StringHelper','CONVERSATION_MODEL_PROVIDER','Model','__metadata','notifyCountingNotReadMessageInConversation','total','length','toString','decorate','socketUserService','CONVERSATION_TYPE','truncate','save','eventName','Injectable','621157jZInyV','emitToUsers','findOne','MESSAGE_EVENT','mongoose','$totalNotReadMessage','Inject','23411xqcXsr','handleNotify','conversationId','metadata','__param','defineProperty','design:paramtypes','623595EiGGdv','2249792tMORls'];const a216_0x55e4e9=a216_0x1fd3;(function(_0x598c8b,_0x396c27){const _0x1315c9=a216_0x1fd3;while(!![]){try{const _0x29e670=parseInt(_0x1315c9(0x16e))+-parseInt(_0x1315c9(0x15f))+-parseInt(_0x1315c9(0x14e))*-parseInt(_0x1315c9(0x176))+parseInt(_0x1315c9(0x187))+parseInt(_0x1315c9(0x155))+parseInt(_0x1315c9(0x174))+-parseInt(_0x1315c9(0x156));if(_0x29e670===_0x396c27)break;else _0x598c8b['push'](_0x598c8b['shift']());}catch(_0x20aaf3){_0x598c8b['push'](_0x598c8b['shift']());}}}(a216_0x4a2b,0x617d1));function a216_0x1fd3(_0x37fd7d,_0x20613e){return a216_0x1fd3=function(_0x4a2bb2,_0x1fd360){_0x4a2bb2=_0x4a2bb2-0x14c;let _0x2669e5=a216_0x4a2b[_0x4a2bb2];return _0x2669e5;},a216_0x1fd3(_0x37fd7d,_0x20613e);}var __decorate=this&&this[a216_0x55e4e9(0x168)]||function(_0x2b0028,_0x5087b3,_0xb34c0c,_0x558de8){const _0x26ce63=a216_0x55e4e9;var _0x3a5fa6=arguments[_0x26ce63(0x17e)],_0x477583=_0x3a5fa6<0x3?_0x5087b3:_0x558de8===null?_0x558de8=Object['getOwnPropertyDescriptor'](_0x5087b3,_0xb34c0c):_0x558de8,_0x26cc86;if(typeof Reflect==='object'&&typeof Reflect[_0x26ce63(0x180)]===_0x26ce63(0x170))_0x477583=Reflect['decorate'](_0x2b0028,_0x5087b3,_0xb34c0c,_0x558de8);else{for(var _0xd84c3a=_0x2b0028[_0x26ce63(0x17e)]-0x1;_0xd84c3a>=0x0;_0xd84c3a--)if(_0x26cc86=_0x2b0028[_0xd84c3a])_0x477583=(_0x3a5fa6<0x3?_0x26cc86(_0x477583):_0x3a5fa6>0x3?_0x26cc86(_0x5087b3,_0xb34c0c,_0x477583):_0x26cc86(_0x5087b3,_0xb34c0c))||_0x477583;}return _0x3a5fa6>0x3&&_0x477583&&Object[_0x26ce63(0x153)](_0x5087b3,_0xb34c0c,_0x477583),_0x477583;},__metadata=this&&this[a216_0x55e4e9(0x17b)]||function(_0x2b0dd1,_0x547208){const _0x170933=a216_0x55e4e9;if(typeof Reflect==='object'&&typeof Reflect[_0x170933(0x151)]===_0x170933(0x170))return Reflect[_0x170933(0x151)](_0x2b0dd1,_0x547208);},__param=this&&this[a216_0x55e4e9(0x152)]||function(_0x3ffc35,_0x106b56){return function(_0x5deaf9,_0xf12637){_0x106b56(_0x5deaf9,_0xf12637,_0x3ffc35);};};Object['defineProperty'](exports,a216_0x55e4e9(0x169),{'value':!![]}),exports['MessageListener']=void 0x0;const common_1=require('@nestjs/common'),kernel_1=require('../../../kernel'),mongoose_1=require(a216_0x55e4e9(0x18b)),socket_user_service_1=require('../../socket/services/socket-user.service'),constants_1=require(a216_0x55e4e9(0x15a)),providers_1=require(a216_0x55e4e9(0x172)),MESSAGE_NOTIFY=a216_0x55e4e9(0x177);let MessageListener=class MessageListener{constructor(_0x45adb7,_0x3ccd99,_0x3a46c8,_0x5e7cff){const _0x306780=a216_0x55e4e9;this['queueEventService']=_0x45adb7,this[_0x306780(0x181)]=_0x3ccd99,this['conversationModel']=_0x3a46c8,this[_0x306780(0x158)]=_0x5e7cff,this['queueEventService']['subscribe'](constants_1['MESSAGE_CHANNEL'],MESSAGE_NOTIFY,this[_0x306780(0x16a)][_0x306780(0x167)](this));}async['handleMessage'](_0x2390a5){const _0x5c971b=a216_0x55e4e9;if(_0x2390a5[_0x5c971b(0x185)]!==constants_1[_0x5c971b(0x18a)][_0x5c971b(0x159)])return;const _0x1383c0=_0x2390a5[_0x5c971b(0x16d)],_0x4887c5=await this[_0x5c971b(0x15e)][_0x5c971b(0x189)]({'_id':_0x1383c0[_0x5c971b(0x150)]})[_0x5c971b(0x171)]()['exec']();if(![constants_1[_0x5c971b(0x182)]['PRIVATE'],constants_1['CONVERSATION_TYPE'][_0x5c971b(0x15b)]]['includes'](_0x4887c5['type']))return;const _0x483643=(_0x4887c5[_0x5c971b(0x165)]||[])[_0x5c971b(0x162)](_0x7ed67b=>_0x7ed67b['sourceId'])[_0x5c971b(0x160)](_0x1e89cd=>_0x1e89cd[_0x5c971b(0x17f)]()!==_0x1383c0[_0x5c971b(0x16c)][_0x5c971b(0x17f)]());await this[_0x5c971b(0x15d)](_0x4887c5,_0x483643,0x1),await this['handleNotify'](_0x483643,_0x1383c0),await this[_0x5c971b(0x157)](_0x4887c5,_0x1383c0);}async[a216_0x55e4e9(0x157)](_0x52387f,_0x3f7aee){const _0x4b510d=a216_0x55e4e9,_0x1d7df0=kernel_1[_0x4b510d(0x178)][_0x4b510d(0x183)](_0x3f7aee['text']||'',0x1e),_0x4dd2df=_0x3f7aee[_0x4b510d(0x16c)],_0x17487a=_0x3f7aee['createdAt'];await this[_0x4b510d(0x15e)]['updateOne']({'_id':_0x52387f[_0x4b510d(0x173)]},{'$set':{'lastMessage':_0x1d7df0,'lastSenderId':_0x4dd2df,'lastMessageCreatedAt':_0x17487a}},{'upsert':![]});}async[a216_0x55e4e9(0x15d)](_0x3c4327,_0x4d4972,_0x20c4f2=0x1){const _0x2ff2df=a216_0x55e4e9,_0xd2f314=await this[_0x2ff2df(0x158)][_0x2ff2df(0x15c)]({'conversationId':_0x3c4327[_0x2ff2df(0x173)],'recipientId':{'$in':_0x4d4972}});if(_0xd2f314&&_0xd2f314['length']){const _0x342667=_0xd2f314[_0x2ff2df(0x162)](_0x27397a=>_0x27397a[_0x2ff2df(0x173)]);await this['NotificationMessageModel']['updateMany']({'_id':{'$in':_0x342667}},{'$inc':{'totalNotReadMessage':_0x20c4f2},'updatedAt':new Date()},{'upsert':!![]}),_0x4d4972&&_0x4d4972[_0x2ff2df(0x164)](async _0x21424e=>{const _0x3f60b0=_0x2ff2df,_0x20650c=await this[_0x3f60b0(0x158)][_0x3f60b0(0x16b)]([{'$match':{'recipientId':_0x21424e}},{'$group':{'_id':_0x3f60b0(0x163),'total':{'$sum':'$totalNotReadMessage'}}}]);let _0x43ced5=0x0;_0x20650c&&_0x20650c['length']&&_0x20650c['forEach'](_0xf19e7a=>{const _0x4d9fc4=_0x3f60b0;_0xf19e7a['total']&&(_0x43ced5+=_0xf19e7a[_0x4d9fc4(0x17d)]);}),await this[_0x3f60b0(0x17c)](_0x21424e,_0x43ced5);});return;}_0x4d4972[_0x2ff2df(0x164)](async _0x53d117=>{const _0x477615=_0x2ff2df;await new this[(_0x477615(0x158))]({'conversationId':_0x3c4327[_0x477615(0x173)],'recipientId':_0x53d117,'totalNotReadMessage':_0x20c4f2,'updatedAt':new Date(),'createdAt':new Date()})[_0x477615(0x184)]();const _0x4add96=await this[_0x477615(0x158)]['aggregate']([{'$match':{'recipientId':_0x53d117}},{'$group':{'_id':_0x477615(0x163),'total':{'$sum':_0x477615(0x14c)}}}]);let _0x354208=0x0;_0x4add96&&_0x4add96[_0x477615(0x17e)]&&_0x4add96[_0x477615(0x164)](_0x1b07f0=>{const _0x464b7f=_0x477615;_0x1b07f0[_0x464b7f(0x17d)]&&(_0x354208+=_0x1b07f0[_0x464b7f(0x17d)]);}),await this[_0x477615(0x17c)](_0x53d117,_0x354208);});}async[a216_0x55e4e9(0x17c)](_0x5ef588,_0x4f678a){const _0x175070=a216_0x55e4e9;await this[_0x175070(0x181)][_0x175070(0x188)]([_0x5ef588],'nofify_read_messages_in_conversation',{'total':_0x4f678a});}async[a216_0x55e4e9(0x14f)](_0x47feea,_0x5c45c2){const _0x204b4b=a216_0x55e4e9;await this[_0x204b4b(0x181)][_0x204b4b(0x188)](_0x47feea,_0x204b4b(0x161),_0x5c45c2);}};MessageListener=__decorate([common_1[a216_0x55e4e9(0x186)](),__param(0x2,common_1[a216_0x55e4e9(0x14d)](providers_1[a216_0x55e4e9(0x179)])),__param(0x3,common_1[a216_0x55e4e9(0x14d)](providers_1['NOTIFICATION_MESSAGE_MODEL_PROVIDER'])),__metadata(a216_0x55e4e9(0x154),[kernel_1[a216_0x55e4e9(0x16f)],socket_user_service_1[a216_0x55e4e9(0x166)],mongoose_1[a216_0x55e4e9(0x17a)],mongoose_1['Model']])],MessageListener),exports[a216_0x55e4e9(0x175)]=MessageListener;