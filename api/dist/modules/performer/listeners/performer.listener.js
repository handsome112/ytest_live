'use strict';const a330_0x345d=['findOne','../../../kernel/helpers/string.helper','getOwnPropertyDescriptor','__esModule','studioCommission','45278uBJEnQ','ConversationDto','The\x20model\x20is\x20in\x20a\x20Group\x20show\x20and\x20will\x20be\x20back\x20after\x20the\x20show\x20ends.','studioService','save','__param','commission','metadata','emitToRoom','performerService','env','findPerformerPublicConversation','generateUuid','bind','1VKeTwo','emitToConnectedUsers','COMMISSION_RATE','forEach','message_created_conversation_','317336OzejGf','socketUserService','PERFORMER_CHANNEL','../../stream/constant','log','_id','PerformerDto','settingService','The\x20model\x20is\x20in\x20private\x20chat/C2C\x20with\x20another\x20user','6788533UFOJPn','conversationService','publish','STUDIO_COMMISSION','Model','memberCommission','../../socket/services/socket-user.service','toSearchResponse','1810323EnZCIp','GROUP_CHAT','PERFORMER_STEAMING_STATUS_CHANNEL','serializeConversation','SettingService','1470235NRqLsR','merge','1666028fCVRSe','../../studio/services','PERFORMER_COMMISSION','decorate','SETTING_KEYS','../providers','PUBLIC_CHAT','UPDATED','performerStreamStatusHandler','../../../kernel/constants','@nestjs/common','9AnPQbV','getKeyValue','PerformerCommission','function','../dtos','../../message/dtos','191295DIZIUN','performerCommsionService','../services','STUDIO_MEMBER_CHANNEL','OFFLINE','EVENT','data','studioId','INITIALIZE_COMMISSION','../../settings/constants','eventName','../../message/services','1AqUAcv','object','lodash','modelUpdateStreamingStatus','PERFORMER_COMMISSION_MODEL_PROVIDER','../../settings','../constants','Inject','defineProperty','SocketUserService','length','subscribe','PERFORMER_STUDIO_UPDATED','design:paramtypes','QueueEventService','performerId','PerformerListener','set'];const a330_0x160ba7=a330_0xdc41;(function(_0x4b5395,_0x1ebcac){const _0x48db03=a330_0xdc41;while(!![]){try{const _0x2f9425=-parseInt(_0x48db03(0x119))+-parseInt(_0x48db03(0xfe))*parseInt(_0x48db03(0x103))+parseInt(_0x48db03(0x126))*-parseInt(_0x48db03(0x14f))+-parseInt(_0x48db03(0x114))*parseInt(_0x48db03(0x138))+-parseInt(_0x48db03(0x11b))+-parseInt(_0x48db03(0x12c))+parseInt(_0x48db03(0x10c));if(_0x2f9425===_0x1ebcac)break;else _0x4b5395['push'](_0x4b5395['shift']());}catch(_0x4aaf5f){_0x4b5395['push'](_0x4b5395['shift']());}}}(a330_0x345d,0xe2076));function a330_0xdc41(_0x23d468,_0x4e99b8){return a330_0xdc41=function(_0x345d3b,_0xdc419a){_0x345d3b=_0x345d3b-0xfa;let _0x115899=a330_0x345d[_0x345d3b];return _0x115899;},a330_0xdc41(_0x23d468,_0x4e99b8);}var __decorate=this&&this['__decorate']||function(_0x10ec67,_0x300649,_0x1e6fcf,_0x114d9d){const _0x402b43=a330_0xdc41;var _0x346d98=arguments[_0x402b43(0x142)],_0x40bf3a=_0x346d98<0x3?_0x300649:_0x114d9d===null?_0x114d9d=Object[_0x402b43(0x14c)](_0x300649,_0x1e6fcf):_0x114d9d,_0x5f58ce;if(typeof Reflect==='object'&&typeof Reflect[_0x402b43(0x11e)]==='function')_0x40bf3a=Reflect['decorate'](_0x10ec67,_0x300649,_0x1e6fcf,_0x114d9d);else{for(var _0x23980a=_0x10ec67[_0x402b43(0x142)]-0x1;_0x23980a>=0x0;_0x23980a--)if(_0x5f58ce=_0x10ec67[_0x23980a])_0x40bf3a=(_0x346d98<0x3?_0x5f58ce(_0x40bf3a):_0x346d98>0x3?_0x5f58ce(_0x300649,_0x1e6fcf,_0x40bf3a):_0x5f58ce(_0x300649,_0x1e6fcf))||_0x40bf3a;}return _0x346d98>0x3&&_0x40bf3a&&Object['defineProperty'](_0x300649,_0x1e6fcf,_0x40bf3a),_0x40bf3a;},__metadata=this&&this['__metadata']||function(_0x665e66,_0x5e8d7d){const _0x287748=a330_0xdc41;if(typeof Reflect===_0x287748(0x139)&&typeof Reflect['metadata']===_0x287748(0x129))return Reflect[_0x287748(0x156)](_0x665e66,_0x5e8d7d);},__param=this&&this[a330_0x160ba7(0x154)]||function(_0x1904cf,_0x20d5ff){return function(_0x1b47f,_0xd5faa3){_0x20d5ff(_0x1b47f,_0xd5faa3,_0x1904cf);};};Object[a330_0x160ba7(0x140)](exports,a330_0x160ba7(0x14d),{'value':!![]}),exports[a330_0x160ba7(0x148)]=void 0x0;const common_1=require(a330_0x160ba7(0x125)),mongoose_1=require('mongoose'),lodash_1=require(a330_0x160ba7(0x13a)),kernel_1=require('../../../kernel'),constants_1=require(a330_0x160ba7(0x13e)),settings_1=require(a330_0x160ba7(0x13d)),constants_2=require(a330_0x160ba7(0x135)),constant_1=require(a330_0x160ba7(0x106)),services_1=require(a330_0x160ba7(0x11c)),socket_user_service_1=require(a330_0x160ba7(0x112)),services_2=require(a330_0x160ba7(0x137)),dtos_1=require(a330_0x160ba7(0x12b)),string_helper_1=require(a330_0x160ba7(0x14b)),constants_3=require(a330_0x160ba7(0x124)),providers_1=require(a330_0x160ba7(0x120)),services_3=require(a330_0x160ba7(0x12e)),dtos_2=require(a330_0x160ba7(0x12a)),PERFORMER_STUDIO_UPDATED=a330_0x160ba7(0x144),PERFORMER_STEAMING_STATUS_UPDATED='PERFORMER_STEAMING_STATUS_UPDATED';let PerformerListener=class PerformerListener{constructor(_0x350491,_0x35339b,_0x5d1f5e,_0x465716,_0x405654,_0x25b473,_0x259353,_0xc23c4c){const _0x249dc5=a330_0x160ba7;this[_0x249dc5(0x128)]=_0x350491,this['queueEventService']=_0x35339b,this[_0x249dc5(0x12d)]=_0x5d1f5e,this[_0x249dc5(0x10a)]=_0x465716,this[_0x249dc5(0x152)]=_0x405654,this[_0x249dc5(0x158)]=_0x25b473,this[_0x249dc5(0x104)]=_0x259353,this[_0x249dc5(0x10d)]=_0xc23c4c,this['queueEventService']['subscribe'](constants_1[_0x249dc5(0x105)],PERFORMER_STUDIO_UPDATED,this['studioUpdatedHandler'][_0x249dc5(0xfd)](this)),this['queueEventService'][_0x249dc5(0x143)](constants_1[_0x249dc5(0x116)],PERFORMER_STEAMING_STATUS_UPDATED,this['performerStreamStatusHandler'][_0x249dc5(0xfd)](this));}async['studioUpdatedHandler'](_0x58c0de){const _0x4f6c14=a330_0x160ba7;if(_0x58c0de[_0x4f6c14(0x136)]!==constants_3[_0x4f6c14(0x131)][_0x4f6c14(0x122)])return;const {performer:_0x520601,oldStudioId:_0x2aa163}=_0x58c0de[_0x4f6c14(0x132)];if(_0x520601[_0x4f6c14(0x133)]&&''+_0x520601['studioId']!==''+_0x2aa163){const _0x3259c7=await this[_0x4f6c14(0x152)]['findById'](_0x520601[_0x4f6c14(0x133)]);if(!_0x3259c7)return;const [_0x33ea05,_0x280d38]=await Promise['all']([this['settingService'][_0x4f6c14(0x127)](constants_2['SETTING_KEYS'][_0x4f6c14(0x11d)])||0x0,this[_0x4f6c14(0x10a)][_0x4f6c14(0x127)](constants_2[_0x4f6c14(0x11f)][_0x4f6c14(0x10f)])||0x0]);let _0x266b14=await this[_0x4f6c14(0x12d)][_0x4f6c14(0x14a)]({'performerId':_0x520601[_0x4f6c14(0x108)]});if(_0x266b14){_0x266b14[_0x4f6c14(0x14e)]=_0x3259c7[_0x4f6c14(0x155)]||_0x280d38,_0x266b14[_0x4f6c14(0x111)]=parseInt(process[_0x4f6c14(0xfa)]['COMMISSION_RATE'],0xa),await _0x266b14['save']();return;}_0x266b14=new this[(_0x4f6c14(0x128))]();const _0x140810={'performerId':_0x520601[_0x4f6c14(0x108)],'tipCommission':_0x33ea05,'albumCommission':_0x33ea05,'groupCallCommission':_0x33ea05,'privateCallCommission':_0x33ea05,'productCommission':_0x33ea05,'videoCommission':_0x33ea05,'studioCommission':_0x3259c7['commission']||_0x280d38,'memberCommission':parseInt(process[_0x4f6c14(0xfa)][_0x4f6c14(0x100)],0xa)};lodash_1[_0x4f6c14(0x11a)](_0x266b14,_0x140810),await _0x266b14[_0x4f6c14(0x153)]();}if(!_0x520601[_0x4f6c14(0x133)]&&_0x2aa163){let _0x31030c=await this[_0x4f6c14(0x12d)][_0x4f6c14(0x14a)]({'performerId':_0x520601[_0x4f6c14(0x108)]});if(!_0x31030c){const _0x412218=await this[_0x4f6c14(0x10a)]['getKeyValue'](constants_2[_0x4f6c14(0x11f)][_0x4f6c14(0x11d)])||0x0;_0x31030c=new this[(_0x4f6c14(0x128))](),_0x31030c[_0x4f6c14(0x149)](_0x4f6c14(0x147),_0x520601[_0x4f6c14(0x108)]),constants_1[_0x4f6c14(0x134)][_0x4f6c14(0x101)](_0x34afa9=>{_0x31030c[_0x34afa9]=_0x412218;});}_0x31030c[_0x4f6c14(0x14e)]=0x1,await _0x31030c[_0x4f6c14(0x153)](),await this['queueEventService'][_0x4f6c14(0x10e)]({'channel':_0x4f6c14(0x12f),'eventName':constants_3[_0x4f6c14(0x131)][_0x4f6c14(0x122)],'data':{'studioId':_0x2aa163,'total':-0x1}});}}async[a330_0x160ba7(0x123)](_0x112471){const _0x246284=a330_0x160ba7;try{if(![constant_1['PRIVATE_CHAT'],constant_1['GROUP_CHAT'],constant_1[_0x246284(0x121)],constant_1[_0x246284(0x130)]]['includes'](_0x112471[_0x246284(0x136)]))return;const {id:_0x383211}=_0x112471['data'],_0x4960e7=await this[_0x246284(0x158)]['findById'](_0x383211);if(!_0x4960e7)return;await this[_0x246284(0x104)][_0x246284(0xff)](_0x246284(0x13b),{'id':_0x383211,'performer':new dtos_2[(_0x246284(0x109))](_0x4960e7)[_0x246284(0x113)](),'status':_0x112471[_0x246284(0x136)]});const _0x664cf9=await this[_0x246284(0x10d)][_0x246284(0xfb)](_0x383211);if(!_0x664cf9)return;const _0x28af70=new dtos_1[(_0x246284(0x150))](_0x664cf9),_0x14cf45=_0x28af70[_0x246284(0x117)]();if(_0x112471[_0x246284(0x136)]===constant_1['PRIVATE_CHAT'])await this[_0x246284(0x104)][_0x246284(0x157)](_0x14cf45,_0x246284(0x102)+_0x664cf9[_0x246284(0x108)],{'_id':string_helper_1[_0x246284(0xfc)](),'text':_0x246284(0x10b),'conversationId':_0x664cf9[_0x246284(0x108)],'isSystem':!![]});else _0x112471['eventName']===constant_1[_0x246284(0x115)]&&await this[_0x246284(0x104)][_0x246284(0x157)](_0x14cf45,_0x246284(0x102)+_0x664cf9[_0x246284(0x108)],{'_id':string_helper_1[_0x246284(0xfc)](),'text':_0x246284(0x151),'conversationId':_0x664cf9['_id'],'isSystem':!![]});}catch(_0x2e20ea){console[_0x246284(0x107)](_0x2e20ea);}}};PerformerListener=__decorate([common_1['Injectable'](),__param(0x0,common_1[a330_0x160ba7(0x13f)](providers_1[a330_0x160ba7(0x13c)])),__metadata(a330_0x160ba7(0x145),[mongoose_1[a330_0x160ba7(0x110)],kernel_1[a330_0x160ba7(0x146)],services_3['PerformerCommissionService'],settings_1[a330_0x160ba7(0x118)],services_1['StudioService'],services_3['PerformerService'],socket_user_service_1[a330_0x160ba7(0x141)],services_2['ConversationService']])],PerformerListener),exports[a330_0x160ba7(0x148)]=PerformerListener;