'use strict';const a514_0xfacd=['source','CONNECTED','handshake','1LVlWpo','AuthService','1gjNdyA','length','../../auth/services','handleConnection','authService','getOwnPropertyDescriptor','verifyJWT','USER_SOCKET_CONNECTED_CHANNEL','QueueEventService','design:type','decorate','handleReconnection','__param','361579qMFktc','pick','query','queueEventService','WebSocketGateway','reconnect','token','33698nEpIGv','1025XnClLt','defineProperty','WsUserConnectedGateway','handleDisconnect','addConnection','477347qHRtKD','../constants','USER_SOCKET_EVENT','../../stream/constant','includes','object','LIVE_STREAM_EVENT_NAME','user','metadata','getUserSocketIds','removeConnection','design:returntype','../../auth/dtos','Inject','235208fSNzID','6buDkPj','all','11HKbPTi','design:paramtypes','performer','publish','PERFORMER_LIVE_STREAM_CHANNEL','../../../kernel','3561enyFpr','function','__decorate','31483OTeyhR','__esModule','@nestjs/websockets','lodash','@nestjs/common','SubscribeMessage','authId','connect','sourceId','prototype','DISCONNECTED','../services/socket-user.service','logout','83OxCMeh','login','socketUserService','1RvnJSf'];const a514_0x4b70a2=a514_0x4236;(function(_0x38a26f,_0x3f28af){const _0x545ca6=a514_0x4236;while(!![]){try{const _0x2fa6b5=-parseInt(_0x545ca6(0xac))*parseInt(_0x545ca6(0x75))+parseInt(_0x545ca6(0x82))*parseInt(_0x545ca6(0xb0))+-parseInt(_0x545ca6(0xb2))*parseInt(_0x545ca6(0x7c))+-parseInt(_0x545ca6(0x7d))*-parseInt(_0x545ca6(0x91))+-parseInt(_0x545ca6(0x99))*parseInt(_0x545ca6(0xa9))+-parseInt(_0x545ca6(0x93))*-parseInt(_0x545ca6(0x9c))+parseInt(_0x545ca6(0x90));if(_0x2fa6b5===_0x3f28af)break;else _0x38a26f['push'](_0x38a26f['shift']());}catch(_0x54bfe2){_0x38a26f['push'](_0x38a26f['shift']());}}}(a514_0xfacd,0x5b5a2));function a514_0x4236(_0x53fde6,_0x19af6c){return a514_0x4236=function(_0xfacd3c,_0x423675){_0xfacd3c=_0xfacd3c-0x74;let _0x4bfa83=a514_0xfacd[_0xfacd3c];return _0x4bfa83;},a514_0x4236(_0x53fde6,_0x19af6c);}var __decorate=this&&this[a514_0x4b70a2(0x9b)]||function(_0x1decf6,_0x5618f0,_0x410db5,_0x5aba7d){const _0x34bc19=a514_0x4b70a2;var _0x4a352b=arguments[_0x34bc19(0xb3)],_0x3c490e=_0x4a352b<0x3?_0x5618f0:_0x5aba7d===null?_0x5aba7d=Object[_0x34bc19(0xb7)](_0x5618f0,_0x410db5):_0x5aba7d,_0x1df3b5;if(typeof Reflect===_0x34bc19(0x87)&&typeof Reflect[_0x34bc19(0xbc)]==='function')_0x3c490e=Reflect[_0x34bc19(0xbc)](_0x1decf6,_0x5618f0,_0x410db5,_0x5aba7d);else{for(var _0x5c69e3=_0x1decf6[_0x34bc19(0xb3)]-0x1;_0x5c69e3>=0x0;_0x5c69e3--)if(_0x1df3b5=_0x1decf6[_0x5c69e3])_0x3c490e=(_0x4a352b<0x3?_0x1df3b5(_0x3c490e):_0x4a352b>0x3?_0x1df3b5(_0x5618f0,_0x410db5,_0x3c490e):_0x1df3b5(_0x5618f0,_0x410db5))||_0x3c490e;}return _0x4a352b>0x3&&_0x3c490e&&Object[_0x34bc19(0x7e)](_0x5618f0,_0x410db5,_0x3c490e),_0x3c490e;},__metadata=this&&this['__metadata']||function(_0x55955f,_0x2dbe0d){const _0x4a4285=a514_0x4b70a2;if(typeof Reflect===_0x4a4285(0x87)&&typeof Reflect[_0x4a4285(0x8a)]===_0x4a4285(0x9a))return Reflect[_0x4a4285(0x8a)](_0x55955f,_0x2dbe0d);},__param=this&&this[a514_0x4b70a2(0x74)]||function(_0x65c354,_0x9410b3){return function(_0x10158c,_0x509f9b){_0x9410b3(_0x10158c,_0x509f9b,_0x65c354);};};Object[a514_0x4b70a2(0x7e)](exports,a514_0x4b70a2(0x9d),{'value':!![]}),exports[a514_0x4b70a2(0x7f)]=void 0x0;const websockets_1=require(a514_0x4b70a2(0x9e)),services_1=require(a514_0x4b70a2(0xb4)),lodash_1=require(a514_0x4b70a2(0x9f)),kernel_1=require(a514_0x4b70a2(0x98)),constant_1=require(a514_0x4b70a2(0x85)),dtos_1=require(a514_0x4b70a2(0x8e)),common_1=require(a514_0x4b70a2(0xa0)),socket_user_service_1=require(a514_0x4b70a2(0xa7)),constants_1=require(a514_0x4b70a2(0x83));let WsUserConnectedGateway=class WsUserConnectedGateway{constructor(_0x454c8e,_0x1f2273,_0xeb9969){const _0x584abc=a514_0x4b70a2;this['authService']=_0x454c8e,this[_0x584abc(0xab)]=_0x1f2273,this['queueEventService']=_0xeb9969;}async[a514_0x4b70a2(0xb5)](_0x45e9fa){const _0x5beffe=a514_0x4b70a2;if(!_0x45e9fa['handshake'][_0x5beffe(0x77)]['token'])return;await this[_0x5beffe(0xaa)](_0x45e9fa,_0x45e9fa[_0x5beffe(0xaf)][_0x5beffe(0x77)][_0x5beffe(0x7b)]);}async['handleReconnection'](_0x2891b2){const _0x92b8bc=a514_0x4b70a2;if(!_0x2891b2[_0x92b8bc(0xaf)][_0x92b8bc(0x77)][_0x92b8bc(0x7b)])return;await this[_0x92b8bc(0xaa)](_0x2891b2,_0x2891b2[_0x92b8bc(0xaf)][_0x92b8bc(0x77)]['token']);}async[a514_0x4b70a2(0x80)](_0x1ee1f2){const _0x5332c2=a514_0x4b70a2;if(!_0x1ee1f2['handshake'][_0x5332c2(0x77)][_0x5332c2(0x7b)])return;await this[_0x5332c2(0xa8)](_0x1ee1f2,_0x1ee1f2[_0x5332c2(0xaf)][_0x5332c2(0x77)][_0x5332c2(0x7b)]);}async[a514_0x4b70a2(0xaa)](_0x4a8be7,_0x183ad1){const _0x1f6dc8=a514_0x4b70a2,_0x11034f=this[_0x1f6dc8(0xb6)][_0x1f6dc8(0xb8)](_0x183ad1);if(!_0x11034f)return;const _0x595ccc=lodash_1['pick'](_0x11034f,['source',_0x1f6dc8(0xa4),'authId']);await this[_0x1f6dc8(0xab)][_0x1f6dc8(0x81)](_0x595ccc[_0x1f6dc8(0xa4)],_0x4a8be7['id']);switch(_0x595ccc['source']){case _0x1f6dc8(0x89):await this['queueEventService']['publish']({'channel':constants_1[_0x1f6dc8(0xb9)],'eventName':constants_1['USER_SOCKET_EVENT'][_0x1f6dc8(0xae)],'data':_0x595ccc});break;case _0x1f6dc8(0x95):await this['queueEventService'][_0x1f6dc8(0x96)]({'channel':constants_1['PERFORMER_SOCKET_CONNECTED_CHANNEL'],'eventName':constants_1['USER_SOCKET_EVENT'][_0x1f6dc8(0xae)],'data':_0x595ccc});break;default:break;}}async[a514_0x4b70a2(0xa8)](_0xc4a393,_0x5c9469){const _0x3bb162=a514_0x4b70a2,_0x9e71d9=this[_0x3bb162(0xb6)]['decodeJWT'](_0x5c9469);if(!_0x9e71d9)return;const _0x40f78b=lodash_1[_0x3bb162(0x76)](_0x9e71d9,[_0x3bb162(0xad),'sourceId',_0x3bb162(0xa2)]),_0x201e6c=await this['socketUserService'][_0x3bb162(0x8b)](_0x40f78b[_0x3bb162(0xa4)]);if(!_0x201e6c[_0x3bb162(0xb3)])return;if(!_0x201e6c[_0x3bb162(0x86)](_0xc4a393['id']))return;const _0x457985=await this[_0x3bb162(0xab)][_0x3bb162(0x8c)](_0x40f78b['sourceId'],_0xc4a393['id']);if(_0x457985)return;if(_0x40f78b[_0x3bb162(0xad)]==='user')await Promise[_0x3bb162(0x92)]([this['queueEventService'][_0x3bb162(0x96)]({'channel':constants_1[_0x3bb162(0xb9)],'eventName':constants_1[_0x3bb162(0x84)][_0x3bb162(0xa6)],'data':_0x40f78b}),this[_0x3bb162(0x78)][_0x3bb162(0x96)]({'channel':constant_1['USER_LIVE_STREAM_CHANNEL'],'eventName':constant_1[_0x3bb162(0x88)][_0x3bb162(0xa6)],'data':_0x40f78b['sourceId']})]);else _0x40f78b['source']===_0x3bb162(0x95)&&await Promise[_0x3bb162(0x92)]([this[_0x3bb162(0x78)]['publish']({'channel':constants_1['PERFORMER_SOCKET_CONNECTED_CHANNEL'],'eventName':constants_1[_0x3bb162(0x84)]['DISCONNECTED'],'data':_0x40f78b}),this[_0x3bb162(0x78)][_0x3bb162(0x96)]({'channel':constant_1[_0x3bb162(0x97)],'eventName':constant_1[_0x3bb162(0x88)][_0x3bb162(0xa6)],'data':_0x40f78b['sourceId']})]);}};__decorate([websockets_1['SubscribeMessage'](a514_0x4b70a2(0xa3)),__metadata('design:type',Function),__metadata('design:paramtypes',[Object]),__metadata('design:returntype',Promise)],WsUserConnectedGateway[a514_0x4b70a2(0xa5)],a514_0x4b70a2(0xb5),null),__decorate([websockets_1[a514_0x4b70a2(0xa1)](a514_0x4b70a2(0x7a)),__metadata(a514_0x4b70a2(0xbb),Function),__metadata('design:paramtypes',[Object]),__metadata(a514_0x4b70a2(0x8d),Promise)],WsUserConnectedGateway[a514_0x4b70a2(0xa5)],a514_0x4b70a2(0xbd),null),__decorate([websockets_1['SubscribeMessage']('disconnect'),__metadata(a514_0x4b70a2(0xbb),Function),__metadata('design:paramtypes',[Object]),__metadata(a514_0x4b70a2(0x8d),Promise)],WsUserConnectedGateway['prototype'],'handleDisconnect',null),WsUserConnectedGateway=__decorate([websockets_1[a514_0x4b70a2(0x79)](),__param(0x0,common_1[a514_0x4b70a2(0x8f)](common_1['forwardRef'](()=>services_1[a514_0x4b70a2(0xb1)]))),__metadata(a514_0x4b70a2(0x94),[services_1[a514_0x4b70a2(0xb1)],socket_user_service_1['SocketUserService'],kernel_1[a514_0x4b70a2(0xba)]])],WsUserConnectedGateway),exports[a514_0x4b70a2(0x7f)]=WsUserConnectedGateway;