'use strict';const a535_0x4d90=['Inject','@nestjs/common','push','../../user/dtos','../../../kernel/helpers/string.helper','WebSocketGateway','../../message/services','authService','streamModel','defaultStreamValue','RequestService','../services','conversationId','log','source','../../socket/services/socket-user.service','isStreaming','metadata','isPerformer','ConversationService','addConnectionToRoom','assign','\x20has\x20joined\x20this\x20conversation','handshake','JOINED_THE_ROOM','handleReJoinPrivateRoom','\x20has\x20left\x20this\x20conversation','../../performer/services','12270hpuLuX','378937omOKib','mongoose','522513EdVoGj','__metadata','map','527614xKrdKm','performer','error','lodash','findById','Model','1359445hpWNTd','emitToRoom','2HkXiAF','defineProperty','function','LiveStream','../../auth/services','getRoomUserConnections','1357119KUmfrw','../providers/stream.provider','design:paramtypes','user','toResponse','AuthService','emitToUsers','handleJoinPrivateRoom','BroadcastType','performerService','conversationService','3323230hMiRAR','SocketUserService','userService','generateUuid','lastStreamingTime','performerId','REJOIN_ROOM','@nestjs/websockets','streamIds','../../user/services','streamId','../../auth/dtos','setStreamingStatus','findOne','STREAM_MODEL_PROVIDER','MODEL_LEFT_ROOM','rooms','finished','leave','model','message_created_conversation_','type','SubscribeMessage','adapter','__param','pick','handleLeavePrivateRoom','requestService','prototype','keys','JOIN_ROOM','design:type','getSourceFromJWT','sourceId','serializeConversation','design:returntype','getConnectionValue','findByIds','PerformerService','username','StreamConversationWsGateway','decorate','length','all','member','socketUserService','LEAVE_ROOM','verifyJWT','create','split','join','_id','object','query','forEach'];const a535_0x5cbc65=a535_0x54d4;(function(_0x259ef0,_0x2a1a0c){const _0x3bcb16=a535_0x54d4;while(!![]){try{const _0x56cd72=-parseInt(_0x3bcb16(0x19a))+-parseInt(_0x3bcb16(0x1a2))+-parseInt(_0x3bcb16(0x18f))+-parseInt(_0x3bcb16(0x191))+-parseInt(_0x3bcb16(0x18e))+parseInt(_0x3bcb16(0x19c))*parseInt(_0x3bcb16(0x194))+parseInt(_0x3bcb16(0x13b));if(_0x56cd72===_0x2a1a0c)break;else _0x259ef0['push'](_0x259ef0['shift']());}catch(_0x4099a2){_0x259ef0['push'](_0x259ef0['shift']());}}}(a535_0x4d90,0xb6a8e));function a535_0x54d4(_0x5b995f,_0x25501c){return a535_0x54d4=function(_0x4d90be,_0x54d458){_0x4d90be=_0x4d90be-0x139;let _0x4d6e1b=a535_0x4d90[_0x4d90be];return _0x4d6e1b;},a535_0x54d4(_0x5b995f,_0x25501c);}var __decorate=this&&this['__decorate']||function(_0x181f6c,_0x3be84a,_0x343b04,_0x4fadc7){const _0x32b38b=a535_0x54d4;var _0x39c202=arguments['length'],_0x5f201f=_0x39c202<0x3?_0x3be84a:_0x4fadc7===null?_0x4fadc7=Object['getOwnPropertyDescriptor'](_0x3be84a,_0x343b04):_0x4fadc7,_0x44b46c;if(typeof Reflect===_0x32b38b(0x16f)&&typeof Reflect[_0x32b38b(0x164)]==='function')_0x5f201f=Reflect[_0x32b38b(0x164)](_0x181f6c,_0x3be84a,_0x343b04,_0x4fadc7);else{for(var _0x31f306=_0x181f6c[_0x32b38b(0x165)]-0x1;_0x31f306>=0x0;_0x31f306--)if(_0x44b46c=_0x181f6c[_0x31f306])_0x5f201f=(_0x39c202<0x3?_0x44b46c(_0x5f201f):_0x39c202>0x3?_0x44b46c(_0x3be84a,_0x343b04,_0x5f201f):_0x44b46c(_0x3be84a,_0x343b04))||_0x5f201f;}return _0x39c202>0x3&&_0x5f201f&&Object[_0x32b38b(0x19d)](_0x3be84a,_0x343b04,_0x5f201f),_0x5f201f;},__metadata=this&&this[a535_0x5cbc65(0x192)]||function(_0xa91d2d,_0x34ff3d){const _0x4d32d5=a535_0x5cbc65;if(typeof Reflect===_0x4d32d5(0x16f)&&typeof Reflect[_0x4d32d5(0x183)]===_0x4d32d5(0x19e))return Reflect[_0x4d32d5(0x183)](_0xa91d2d,_0x34ff3d);},__param=this&&this[a535_0x5cbc65(0x153)]||function(_0x26487f,_0x43fdb0){return function(_0x39ed9d,_0x3d7efb){_0x43fdb0(_0x39ed9d,_0x3d7efb,_0x26487f);};};Object[a535_0x5cbc65(0x19d)](exports,'__esModule',{'value':!![]}),exports[a535_0x5cbc65(0x163)]=void 0x0;const websockets_1=require(a535_0x5cbc65(0x142)),common_1=require(a535_0x5cbc65(0x173)),socket_user_service_1=require(a535_0x5cbc65(0x181)),services_1=require(a535_0x5cbc65(0x17d)),services_2=require(a535_0x5cbc65(0x1a0)),services_3=require(a535_0x5cbc65(0x178)),mongoose_1=require(a535_0x5cbc65(0x190)),services_4=require(a535_0x5cbc65(0x144)),dtos_1=require(a535_0x5cbc65(0x175)),services_5=require(a535_0x5cbc65(0x18d)),string_helper_1=require(a535_0x5cbc65(0x176)),lodash_1=require(a535_0x5cbc65(0x197)),dtos_2=require(a535_0x5cbc65(0x146)),stream_provider_1=require(a535_0x5cbc65(0x1a3)),constant_1=require('../constant'),JOINED_THE_ROOM=a535_0x5cbc65(0x18a),MODEL_JOIN_ROOM='MODEL_JOIN_ROOM',MODEL_LEFT_ROOM=a535_0x5cbc65(0x14a),JOIN_ROOM=a535_0x5cbc65(0x159),REJOIN_ROOM=a535_0x5cbc65(0x141),LEAVE_ROOM=a535_0x5cbc65(0x169);let StreamConversationWsGateway=class StreamConversationWsGateway{constructor(_0x11774b,_0x421395,_0x493a7d,_0x3bb088,_0x4f0d2a,_0x265e91,_0x551412){const _0x210bae=a535_0x5cbc65;this['socketUserService']=_0x11774b,this[_0x210bae(0x179)]=_0x421395,this[_0x210bae(0x13a)]=_0x493a7d,this[_0x210bae(0x13d)]=_0x3bb088,this[_0x210bae(0x139)]=_0x4f0d2a,this[_0x210bae(0x156)]=_0x265e91,this['streamModel']=_0x551412;}async['handleJoinPrivateRoom'](_0x8c4e3,_0x517f02){const _0x1cff02=a535_0x5cbc65;try{const {conversationId:_0x5903c8}=_0x517f02,{token:_0x3439dc}=_0x8c4e3[_0x1cff02(0x189)]['query'];if(!_0x3439dc)return;const [_0x49afe3,_0x47497b]=await Promise[_0x1cff02(0x166)]([this[_0x1cff02(0x179)]['getSourceFromJWT'](_0x3439dc),this[_0x1cff02(0x13a)][_0x1cff02(0x198)](_0x5903c8)]);if(!_0x49afe3||!_0x47497b)return;const _0x1a2815=await this[_0x1cff02(0x17a)][_0x1cff02(0x148)]({'_id':_0x47497b[_0x1cff02(0x145)]});if(!_0x1a2815)return;const _0x5611eb=this[_0x1cff02(0x13a)][_0x1cff02(0x15d)](_0x5903c8,_0x47497b[_0x1cff02(0x150)]);_0x8c4e3[_0x1cff02(0x16d)](_0x5611eb),await this[_0x1cff02(0x168)][_0x1cff02(0x19b)](_0x5611eb,_0x1cff02(0x14f)+_0x47497b[_0x1cff02(0x16e)],{'text':_0x49afe3[_0x1cff02(0x162)]+_0x1cff02(0x188),'_id':string_helper_1[_0x1cff02(0x13e)](),'conversationId':_0x47497b[_0x1cff02(0x16e)],'isSystem':!![]});if(_0x49afe3[_0x1cff02(0x184)]&&''+_0x49afe3['_id']===''+_0x47497b[_0x1cff02(0x140)]){await this[_0x1cff02(0x168)]['emitToRoom'](_0x5611eb,MODEL_JOIN_ROOM,{'conversationId':_0x5903c8});const _0xbf189a=_0x47497b[_0x1cff02(0x150)][_0x1cff02(0x16c)]('_');await this[_0x1cff02(0x139)]['setStreamingStatus'](_0x49afe3[_0x1cff02(0x16e)],_0xbf189a[0x1]);}const _0x124a9a=await this[_0x1cff02(0x168)][_0x1cff02(0x1a1)](_0x5611eb),_0x644b9b=[];Object[_0x1cff02(0x158)](_0x124a9a)[_0x1cff02(0x171)](_0x1ffea2=>{const _0x303bcf=_0x1cff02,_0x263f9b=_0x124a9a[_0x1ffea2][_0x303bcf(0x16c)](',');_0x263f9b[0x0]===_0x303bcf(0x167)&&_0x644b9b[_0x303bcf(0x174)](_0x1ffea2);});const _0x1fd7ed=await this['userService'][_0x1cff02(0x160)](_0x644b9b),_0x3af1f5=_0x1a2815[_0x1cff02(0x150)]+'-'+_0x1a2815[_0x1cff02(0x16e)]+'-'+_0x49afe3[_0x1cff02(0x16e)],_0x2d8812=Object[_0x1cff02(0x187)](Object[_0x1cff02(0x187)]({},constant_1[_0x1cff02(0x17b)]),{'streamId':_0x3af1f5,'name':_0x3af1f5,'description':'','type':constant_1[_0x1cff02(0x1aa)][_0x1cff02(0x19f)],'status':_0x1cff02(0x14c)}),_0x1ffcf1=await this['requestService'][_0x1cff02(0x16b)](_0x2d8812);if(_0x1ffcf1['status'])throw _0x1ffcf1[_0x1cff02(0x196)]||_0x1ffcf1['data'];await this[_0x1cff02(0x168)][_0x1cff02(0x1a8)](_0x49afe3['_id'],JOINED_THE_ROOM,{'streamId':_0x3af1f5,'conversationId':_0x5903c8,'total':_0x8c4e3[_0x1cff02(0x152)][_0x1cff02(0x14b)][_0x5611eb]?_0x8c4e3['adapter'][_0x1cff02(0x14b)][_0x5611eb][_0x1cff02(0x165)]:0x0,'members':_0x1fd7ed[_0x1cff02(0x193)](_0x33a9cc=>new dtos_1['UserDto'](_0x33a9cc)['toResponse']()),'streamList':_0x1a2815[_0x1cff02(0x143)]});}catch(_0x39cdd1){console['log'](_0x39cdd1);}}async[a535_0x5cbc65(0x18b)](_0x3bdb90,_0x4a142d){const _0x3a24cf=a535_0x5cbc65;try{const {conversationId:_0x45ffdf}=_0x4a142d,{token:_0x6d0fa3}=_0x3bdb90['handshake'][_0x3a24cf(0x170)];if(!_0x6d0fa3)return;const [_0x1a57d2,_0x1a999f]=await Promise[_0x3a24cf(0x166)]([this[_0x3a24cf(0x179)][_0x3a24cf(0x16a)](_0x6d0fa3),this[_0x3a24cf(0x13a)][_0x3a24cf(0x198)](_0x45ffdf)]);if(!_0x1a999f)return;let _0x44f430;const _0x51fd64=lodash_1[_0x3a24cf(0x154)](_0x1a57d2,[_0x3a24cf(0x180),_0x3a24cf(0x15c),'authId']);_0x51fd64&&_0x51fd64[_0x3a24cf(0x180)]===_0x3a24cf(0x1a5)&&(_0x44f430=await this[_0x3a24cf(0x13d)]['findById'](_0x51fd64[_0x3a24cf(0x15c)]));_0x51fd64&&_0x51fd64[_0x3a24cf(0x180)]===_0x3a24cf(0x195)&&(_0x44f430=await this[_0x3a24cf(0x139)][_0x3a24cf(0x198)](_0x51fd64[_0x3a24cf(0x15c)]));const _0x391178=await this[_0x3a24cf(0x17a)]['findOne']({'_id':_0x1a999f['streamId']});if(!_0x391178)return;const _0x4fe830=this[_0x3a24cf(0x13a)][_0x3a24cf(0x15d)](_0x45ffdf,_0x1a999f[_0x3a24cf(0x150)]);!_0x3bdb90['rooms'][_0x4fe830]&&_0x3bdb90[_0x3a24cf(0x16d)](_0x4fe830);const _0x535f74=await this[_0x3a24cf(0x168)][_0x3a24cf(0x15f)](_0x4fe830,_0x44f430[_0x3a24cf(0x16e)]);!_0x535f74&&this[_0x3a24cf(0x168)][_0x3a24cf(0x186)](_0x4fe830,_0x44f430[_0x3a24cf(0x16e)],_0x51fd64[_0x3a24cf(0x180)]===_0x3a24cf(0x195)?_0x3a24cf(0x14e):'member');await this[_0x3a24cf(0x168)][_0x3a24cf(0x19b)](_0x4fe830,_0x3a24cf(0x14f)+_0x1a999f[_0x3a24cf(0x16e)],{'text':_0x44f430[_0x3a24cf(0x162)]+'\x20has\x20joined\x20this\x20conversation','_id':string_helper_1[_0x3a24cf(0x13e)](),'conversationId':_0x1a999f[_0x3a24cf(0x16e)],'isSystem':!![]});if(_0x44f430[_0x3a24cf(0x184)]&&''+_0x44f430['_id']===''+_0x1a999f[_0x3a24cf(0x140)]){await this[_0x3a24cf(0x168)]['emitToRoom'](_0x4fe830,MODEL_JOIN_ROOM,{'conversationId':_0x45ffdf});const _0x2b0e95=_0x1a999f[_0x3a24cf(0x150)][_0x3a24cf(0x16c)]('_');await this[_0x3a24cf(0x139)][_0x3a24cf(0x147)](_0x44f430[_0x3a24cf(0x16e)],_0x2b0e95[0x1]);}const _0x3e7649=await this[_0x3a24cf(0x168)][_0x3a24cf(0x1a1)](_0x4fe830),_0x131f6b=[];Object[_0x3a24cf(0x158)](_0x3e7649)[_0x3a24cf(0x171)](_0x46253a=>{const _0x21852c=_0x3a24cf,_0x244e3a=_0x3e7649[_0x46253a][_0x21852c(0x16c)](',');_0x244e3a[0x0]===_0x21852c(0x167)&&_0x131f6b[_0x21852c(0x174)](_0x46253a);});const _0x4440f9=await this[_0x3a24cf(0x13d)][_0x3a24cf(0x160)](_0x131f6b);await this['socketUserService'][_0x3a24cf(0x1a8)](_0x44f430['_id'],JOINED_THE_ROOM,{'conversationId':_0x45ffdf,'total':_0x3bdb90[_0x3a24cf(0x152)][_0x3a24cf(0x14b)][_0x4fe830]?_0x3bdb90['adapter'][_0x3a24cf(0x14b)][_0x4fe830]['length']:0x0,'members':_0x4440f9[_0x3a24cf(0x193)](_0x319ca7=>new dtos_1['UserDto'](_0x319ca7)[_0x3a24cf(0x1a6)]()),'streamList':_0x391178[_0x3a24cf(0x143)]});}catch(_0x969b43){console[_0x3a24cf(0x17f)](_0x969b43);}}async[a535_0x5cbc65(0x155)](_0x54d9b5,_0x422979){const _0x23281c=a535_0x5cbc65;try{const {conversationId:_0x5a8648}=_0x422979,{token:_0x5140cd}=_0x54d9b5['handshake'][_0x23281c(0x170)];if(!_0x5140cd)return;const [_0x2c7bae,_0x532504]=await Promise[_0x23281c(0x166)]([this[_0x23281c(0x179)][_0x23281c(0x15b)](_0x5140cd),this[_0x23281c(0x13a)]['findById'](_0x422979[_0x23281c(0x17e)])]);if(!_0x2c7bae||!_0x532504)return;const _0x3146ac=await this[_0x23281c(0x17a)][_0x23281c(0x148)]({'_id':_0x532504[_0x23281c(0x145)]});if(!_0x3146ac)return;const _0x43ce25=this['conversationService'][_0x23281c(0x15d)](_0x5a8648,_0x532504[_0x23281c(0x150)]);_0x54d9b5[_0x23281c(0x14d)](_0x43ce25),await this[_0x23281c(0x168)][_0x23281c(0x19b)](_0x43ce25,'message_created_conversation_'+_0x422979[_0x23281c(0x17e)],{'text':_0x2c7bae[_0x23281c(0x162)]+_0x23281c(0x18c),'_id':string_helper_1[_0x23281c(0x13e)](),'conversationId':_0x422979[_0x23281c(0x17e)],'isSystem':!![]}),_0x2c7bae['isPerformer']&&''+_0x2c7bae[_0x23281c(0x16e)]===''+_0x532504[_0x23281c(0x140)]&&await Promise[_0x23281c(0x166)]([this[_0x23281c(0x168)][_0x23281c(0x19b)](_0x43ce25,MODEL_LEFT_ROOM,{'date':new Date(),'conversationId':_0x5a8648}),this['performerService'][_0x23281c(0x147)](_0x2c7bae[_0x23281c(0x16e)],constant_1['OFFLINE'])]),_0x3146ac['isStreaming']&&(!_0x54d9b5[_0x23281c(0x152)][_0x23281c(0x14b)][_0x43ce25]||_0x3146ac[_0x23281c(0x150)]===constant_1['PRIVATE_CHAT'])&&(_0x3146ac[_0x23281c(0x182)]=![],_0x3146ac[_0x23281c(0x13f)]=new Date(),await _0x3146ac['save']());}catch(_0x36075d){console[_0x23281c(0x17f)](_0x36075d);}}};__decorate([websockets_1[a535_0x5cbc65(0x151)](JOIN_ROOM),__metadata('design:type',Function),__metadata(a535_0x5cbc65(0x1a4),[Object,Object]),__metadata(a535_0x5cbc65(0x15e),Promise)],StreamConversationWsGateway[a535_0x5cbc65(0x157)],a535_0x5cbc65(0x1a9),null),__decorate([websockets_1[a535_0x5cbc65(0x151)](REJOIN_ROOM),__metadata(a535_0x5cbc65(0x15a),Function),__metadata('design:paramtypes',[Object,Object]),__metadata(a535_0x5cbc65(0x15e),Promise)],StreamConversationWsGateway['prototype'],'handleReJoinPrivateRoom',null),__decorate([websockets_1[a535_0x5cbc65(0x151)](LEAVE_ROOM),__metadata(a535_0x5cbc65(0x15a),Function),__metadata('design:paramtypes',[Object,Object]),__metadata('design:returntype',Promise)],StreamConversationWsGateway[a535_0x5cbc65(0x157)],a535_0x5cbc65(0x155),null),StreamConversationWsGateway=__decorate([websockets_1[a535_0x5cbc65(0x177)](),__param(0x1,common_1[a535_0x5cbc65(0x172)](common_1['forwardRef'](()=>services_2[a535_0x5cbc65(0x1a7)]))),__param(0x6,common_1[a535_0x5cbc65(0x172)](stream_provider_1[a535_0x5cbc65(0x149)])),__metadata(a535_0x5cbc65(0x1a4),[socket_user_service_1[a535_0x5cbc65(0x13c)],services_2[a535_0x5cbc65(0x1a7)],services_3[a535_0x5cbc65(0x185)],services_4['UserService'],services_5[a535_0x5cbc65(0x161)],services_1[a535_0x5cbc65(0x17c)],mongoose_1[a535_0x5cbc65(0x199)]])],StreamConversationWsGateway),exports[a535_0x5cbc65(0x163)]=StreamConversationWsGateway;