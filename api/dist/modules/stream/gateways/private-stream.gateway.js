'use strict';const a537_0x29ad=['_id','log','prototype','private-stream/streamJoined','getTime','moment','1545994jnagbe','WebSocketGateway','design:paramtypes','31633PfqgLT','177fBMnKk','requestService','private-stream/streamLeaved','Inject','findByIds','../../performer/services','length','10ROClWS','109522xBGZCo','emitToUsers','handshake','private-chat-request','getOwnPropertyDescriptor','getRoomUserConnections','data','AuthService','504603wdSgDd','model','BROADCASTING','stream_private','824533tsejrH','socketUserService','type','decorate','performerId','removeConnectionFromRoom','metadata','PrivateStreamWsGateway','includes','__esModule','handleLeaveStream','@nestjs/common','RequestService','Model','updateLastStreamingTime','updateOne','defineProperty','3021gKiwaG','emitToRoom','keys','push','CREATED','__decorate','UserDto','map','function','isPerformer','conversationService','SubscribeMessage','serializeConversation','streamId','status','design:returntype','95923MXTvYn','../services','../../user/dtos','findById','../../socket/services/socket-user.service','__metadata','BroadcastStatus','all','authService','streamModel','member','addConnectionToRoom','handleJoinStream','performerService','1eoCTdl','25yQpcga','toPrivateRequestResponse','@nestjs/websockets','mongoose','split','UserService','userService','design:type','private-stream/join','forEach','getSourceFromJWT','query','STREAM_MODEL_PROVIDER','private-stream/streamInformationChanged','../../message/services'];const a537_0x493905=a537_0x5ea7;(function(_0x5b2de0,_0x44348d){const _0xec9b95=a537_0x5ea7;while(!![]){try{const _0x7e77ec=parseInt(_0xec9b95(0x127))*-parseInt(_0xec9b95(0x105))+parseInt(_0xec9b95(0x12f))+-parseInt(_0xec9b95(0x11f))*parseInt(_0xec9b95(0xe7))+parseInt(_0xec9b95(0x126))*parseInt(_0xec9b95(0xf7))+parseInt(_0xec9b95(0x133))+parseInt(_0xec9b95(0x11e))*parseInt(_0xec9b95(0x106))+-parseInt(_0xec9b95(0x11b));if(_0x7e77ec===_0x44348d)break;else _0x5b2de0['push'](_0x5b2de0['shift']());}catch(_0x4002e5){_0x5b2de0['push'](_0x5b2de0['shift']());}}}(a537_0x29ad,0xd907e));var __decorate=this&&this[a537_0x493905(0xec)]||function(_0x5e6f8f,_0xf7ee1e,_0x1b9e2c,_0x57408b){const _0x4c893e=a537_0x493905;var _0x2a30f2=arguments[_0x4c893e(0x125)],_0x6da36b=_0x2a30f2<0x3?_0xf7ee1e:_0x57408b===null?_0x57408b=Object[_0x4c893e(0x12b)](_0xf7ee1e,_0x1b9e2c):_0x57408b,_0x5e5779;if(typeof Reflect==='object'&&typeof Reflect['decorate']===_0x4c893e(0xef))_0x6da36b=Reflect[_0x4c893e(0x136)](_0x5e6f8f,_0xf7ee1e,_0x1b9e2c,_0x57408b);else{for(var _0x5d7335=_0x5e6f8f[_0x4c893e(0x125)]-0x1;_0x5d7335>=0x0;_0x5d7335--)if(_0x5e5779=_0x5e6f8f[_0x5d7335])_0x6da36b=(_0x2a30f2<0x3?_0x5e5779(_0x6da36b):_0x2a30f2>0x3?_0x5e5779(_0xf7ee1e,_0x1b9e2c,_0x6da36b):_0x5e5779(_0xf7ee1e,_0x1b9e2c))||_0x6da36b;}return _0x2a30f2>0x3&&_0x6da36b&&Object[_0x4c893e(0xe6)](_0xf7ee1e,_0x1b9e2c,_0x6da36b),_0x6da36b;},__metadata=this&&this[a537_0x493905(0xfc)]||function(_0x2dbc12,_0x283e61){const _0x1bf9a7=a537_0x493905;if(typeof Reflect==='object'&&typeof Reflect[_0x1bf9a7(0x139)]===_0x1bf9a7(0xef))return Reflect[_0x1bf9a7(0x139)](_0x2dbc12,_0x283e61);},__param=this&&this['__param']||function(_0x1be035,_0x2ef11e){return function(_0x3c8b33,_0x5fc0e5){_0x2ef11e(_0x3c8b33,_0x5fc0e5,_0x1be035);};};function a537_0x5ea7(_0x32f238,_0xa53f0){return a537_0x5ea7=function(_0x29adfe,_0x5ea7ae){_0x29adfe=_0x29adfe-0xe6;let _0x5ab5fc=a537_0x29ad[_0x29adfe];return _0x5ab5fc;},a537_0x5ea7(_0x32f238,_0xa53f0);}Object[a537_0x493905(0xe6)](exports,a537_0x493905(0x13c),{'value':!![]}),exports[a537_0x493905(0x13a)]=void 0x0;const websockets_1=require(a537_0x493905(0x108)),common_1=require(a537_0x493905(0x13e)),socket_user_service_1=require(a537_0x493905(0xfb)),services_1=require('../../auth/services'),mongoose_1=require(a537_0x493905(0x109)),services_2=require('../../user/services'),dtos_1=require(a537_0x493905(0xf9)),services_3=require(a537_0x493905(0x124)),moment=require(a537_0x493905(0x11a)),services_4=require(a537_0x493905(0x114)),constant_1=require('../constant'),stream_provider_1=require('../providers/stream.provider'),services_5=require(a537_0x493905(0xf8)),STREAM_JOINED=a537_0x493905(0x118),STREAM_LEAVED=a537_0x493905(0x121),STREAM_INFORMATION_CHANGED=a537_0x493905(0x113);let PrivateStreamWsGateway=class PrivateStreamWsGateway{constructor(_0x535ce9,_0x9bd5d7,_0x4cb171,_0x4c7491,_0x253488,_0x15ee07,_0x2a257a){const _0x11084f=a537_0x493905;this[_0x11084f(0x134)]=_0x535ce9,this[_0x11084f(0x100)]=_0x9bd5d7,this[_0x11084f(0xff)]=_0x4cb171,this[_0x11084f(0x10c)]=_0x4c7491,this['performerService']=_0x253488,this[_0x11084f(0x120)]=_0x15ee07,this[_0x11084f(0xf1)]=_0x2a257a;}async[a537_0x493905(0x103)](_0x10bd47,_0x3f1b6e){const _0x21e8d8=a537_0x493905;try{const {conversationId:_0x46884f,streamId:_0x258897}=_0x3f1b6e;if(!_0x46884f)return;const {token:_0x26d3ef}=_0x10bd47['handshake'][_0x21e8d8(0x111)];if(!_0x26d3ef)return;const [_0x271d1c,_0x2f3376]=await Promise[_0x21e8d8(0xfe)]([this[_0x21e8d8(0xff)][_0x21e8d8(0x110)](_0x26d3ef),this[_0x21e8d8(0xf1)]['findById'](_0x46884f)]);if(!_0x271d1c||!_0x2f3376)return;await this[_0x21e8d8(0x100)][_0x21e8d8(0x142)]({'_id':_0x2f3376[_0x21e8d8(0xf4)]},{'$addToSet':{'streamIds':_0x258897}});const _0x195aa8=await this[_0x21e8d8(0x120)]['getBroadcast'](_0x258897);if(_0x195aa8[_0x21e8d8(0xf5)])throw _0x195aa8['error']||_0x195aa8[_0x21e8d8(0x12d)];if([constant_1[_0x21e8d8(0xfd)][_0x21e8d8(0xeb)],constant_1['BroadcastStatus'][_0x21e8d8(0x131)]][_0x21e8d8(0x13b)](_0x195aa8[_0x21e8d8(0x12d)][_0x21e8d8(0xf5)])){const _0x1e6f76=this['conversationService'][_0x21e8d8(0xf3)](_0x46884f,_0x2f3376[_0x21e8d8(0x135)]);await this['socketUserService'][_0x21e8d8(0xe8)](_0x1e6f76,STREAM_JOINED,{'streamId':_0x258897,'conversationId':_0x46884f});!_0x271d1c[_0x21e8d8(0xf0)]&&_0x2f3376[_0x21e8d8(0x135)]===_0x21e8d8(0x132)&&await this[_0x21e8d8(0x134)][_0x21e8d8(0x128)](_0x2f3376[_0x21e8d8(0x137)],_0x21e8d8(0x12a),{'user':_0x271d1c[_0x21e8d8(0x107)](),'conversationId':_0x46884f,'streamId':_0x2f3376[_0x21e8d8(0xf4)],'id':_0x258897});await this[_0x21e8d8(0x134)][_0x21e8d8(0x102)](_0x1e6f76,_0x271d1c[_0x21e8d8(0x115)],_0x271d1c['isPerformer']?_0x21e8d8(0x130):'member');const _0xcfa61=await this[_0x21e8d8(0x134)][_0x21e8d8(0x12c)](_0x1e6f76),_0x2d7107=[];Object[_0x21e8d8(0xe9)](_0xcfa61)['forEach'](_0xc857eb=>{const _0x583f88=_0x21e8d8,_0x119775=_0xcfa61[_0xc857eb][_0x583f88(0x10a)](',');_0x119775[0x0]==='member'&&_0x2d7107['push'](_0xc857eb);});if(_0x2d7107[_0x21e8d8(0x125)]){const _0x20c951=await this['userService'][_0x21e8d8(0x123)](_0x2d7107),_0x2c7ac8={'conversationId':_0x46884f,'total':_0x20c951['length'],'members':_0x20c951[_0x21e8d8(0xee)](_0x5f1313=>new dtos_1[(_0x21e8d8(0xed))](_0x5f1313)['toResponse']())};this[_0x21e8d8(0x134)][_0x21e8d8(0xe8)](_0x1e6f76,STREAM_INFORMATION_CHANGED,_0x2c7ac8);}}}catch(_0xc33ef3){console[_0x21e8d8(0x116)](_0xc33ef3);}}async['handleLeaveStream'](_0x262b04,_0x498290){const _0x2f084f=a537_0x493905;try{const {conversationId:_0x471248,streamId:_0x5bb7eb}=_0x498290;if(!_0x471248)return;const {token:_0x5ec29f}=_0x262b04[_0x2f084f(0x129)][_0x2f084f(0x111)];if(!_0x5ec29f)return;const [_0x3eec7b,_0x1aa4dd]=await Promise[_0x2f084f(0xfe)]([this[_0x2f084f(0xff)][_0x2f084f(0x110)](_0x5ec29f),this[_0x2f084f(0xf1)][_0x2f084f(0xfa)](_0x471248)]);if(!_0x3eec7b||!_0x1aa4dd)return;await this['streamModel'][_0x2f084f(0x142)]({'_id':_0x1aa4dd['streamId']},{'$pull':{'streamIds':_0x5bb7eb}});const _0x2ec505=this['conversationService'][_0x2f084f(0xf3)](_0x471248,_0x1aa4dd[_0x2f084f(0x135)]);await this['socketUserService'][_0x2f084f(0xe8)](_0x2ec505,STREAM_LEAVED,{'streamId':_0x5bb7eb,'conversationId':_0x471248});const _0x20ac20=await this['socketUserService']['getConnectionValue'](_0x2ec505,_0x3eec7b[_0x2f084f(0x115)]);if(_0x20ac20){const _0x427059=_0x20ac20[_0x2f084f(0x10a)](','),_0x4d4fba=_0x427059[0x1]?parseInt(_0x427059[0x1],0xa):null,_0xacc19f=_0x427059[0x0];if(_0x4d4fba){const _0x13dfb6=moment()['toDate']()[_0x2f084f(0x119)]()-_0x4d4fba;if(_0xacc19f===_0x2f084f(0x130)&&''+_0x3eec7b[_0x2f084f(0x115)]===''+_0x1aa4dd[_0x2f084f(0x137)])await this[_0x2f084f(0x104)][_0x2f084f(0x141)](_0x3eec7b['_id'],_0x13dfb6);else _0xacc19f==='member'&&await this[_0x2f084f(0x10c)]['updateStats'](_0x3eec7b['_id'],{'stats.totalViewTime':_0x13dfb6});}}await this[_0x2f084f(0x134)][_0x2f084f(0x138)](_0x2ec505,_0x3eec7b['_id']);const _0x391e79=await this['socketUserService']['getRoomUserConnections'](_0x2ec505),_0x4e0232=[];Object[_0x2f084f(0xe9)](_0x391e79)[_0x2f084f(0x10f)](_0x497dd8=>{const _0x15d4ec=_0x2f084f,_0x4610be=_0x391e79[_0x497dd8][_0x15d4ec(0x10a)](',');_0x4610be[0x0]===_0x15d4ec(0x101)&&_0x4e0232[_0x15d4ec(0xea)](_0x497dd8);});const _0x766e1f=_0x4e0232[_0x2f084f(0x125)]?await this[_0x2f084f(0x10c)][_0x2f084f(0x123)](_0x4e0232):[],_0x4c6e75={'conversationId':_0x471248,'total':_0x766e1f[_0x2f084f(0x125)],'members':_0x766e1f[_0x2f084f(0xee)](_0x1e7cf6=>new dtos_1[(_0x2f084f(0xed))](_0x1e7cf6)['toResponse']())};this[_0x2f084f(0x134)][_0x2f084f(0xe8)](_0x2ec505,STREAM_INFORMATION_CHANGED,_0x4c6e75);}catch(_0x31a424){console[_0x2f084f(0x116)](_0x31a424);}}};__decorate([websockets_1[a537_0x493905(0xf2)](a537_0x493905(0x10e)),__metadata(a537_0x493905(0x10d),Function),__metadata(a537_0x493905(0x11d),[Object,Object]),__metadata(a537_0x493905(0xf6),Promise)],PrivateStreamWsGateway[a537_0x493905(0x117)],a537_0x493905(0x103),null),__decorate([websockets_1['SubscribeMessage']('private-stream/leave'),__metadata(a537_0x493905(0x10d),Function),__metadata(a537_0x493905(0x11d),[Object,Object]),__metadata(a537_0x493905(0xf6),Promise)],PrivateStreamWsGateway[a537_0x493905(0x117)],a537_0x493905(0x13d),null),PrivateStreamWsGateway=__decorate([websockets_1[a537_0x493905(0x11c)](),__param(0x1,common_1['Inject'](stream_provider_1[a537_0x493905(0x112)])),__param(0x2,common_1[a537_0x493905(0x122)](common_1['forwardRef'](()=>services_1[a537_0x493905(0x12e)]))),__metadata('design:paramtypes',[socket_user_service_1['SocketUserService'],mongoose_1[a537_0x493905(0x140)],services_1[a537_0x493905(0x12e)],services_2[a537_0x493905(0x10b)],services_3['PerformerService'],services_5[a537_0x493905(0x13f)],services_4['ConversationService']])],PrivateStreamWsGateway),exports[a537_0x493905(0x13a)]=PrivateStreamWsGateway;