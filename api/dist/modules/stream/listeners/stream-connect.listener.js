'use strict';const a540_0x4eed=['StreamConnectListener','function','defineProperty','../../socket/services/socket-user.service','object','getOwnPropertyDescriptor','Injectable','SocketUserService','__param','131395SNzKXl','leftRoom','metadata','userGetAllConnectedRooms','1205085FpJBsM','PerformerService','@nestjs/common','streamService','../../../kernel/helpers/string.helper','1SxgXtg','__esModule','1sbUyvI','1001523qBAPUY','1odTxUc','userService','ConversationService','findById','all','username','\x20has\x20left\x20this\x20conversation','emitToRoom','data','PERFORMER_LIVE_STREAM_CHANNEL','QueueEventService','STREAM_MODEL_PROVIDER','__decorate','194608jwykkG','queueEventService','subscribe','modelDisconnectHandler','USER_LIVE_STREAM_CHANNEL','1222041nShIwW','decorate','userDisconnectHandler','updateMany','map','socketUserService','DISCONNECTED','Inject','design:paramtypes','removeConnectionFromRoom','message_created_conversation_','MODEL_LIVE_STREAM_CONNECTED','findByIds','USER_LIVE_STREAM_CONNECTED','deserializeConversationId','__metadata','157272XBfPZr','mongoose','conversationService','../../performer/services','../../../kernel','../../user/services','length','../providers/stream.provider','performerService','530180oialGi','../../message/services'];const a540_0x323918=a540_0x524f;(function(_0xf63e08,_0x17fcdc){const _0x1177a7=a540_0x524f;while(!![]){try{const _0x401b4a=-parseInt(_0x1177a7(0xa9))+-parseInt(_0x1177a7(0x87))*-parseInt(_0x1177a7(0x86))+-parseInt(_0x1177a7(0x83))*-parseInt(_0x1177a7(0x94))+-parseInt(_0x1177a7(0x99))+parseInt(_0x1177a7(0x85))*-parseInt(_0x1177a7(0x6f))+parseInt(_0x1177a7(0x7a))+parseInt(_0x1177a7(0x7e));if(_0x401b4a===_0x17fcdc)break;else _0xf63e08['push'](_0xf63e08['shift']());}catch(_0x1cbd76){_0xf63e08['push'](_0xf63e08['shift']());}}}(a540_0x4eed,0x9820e));function a540_0x524f(_0x13617b,_0x350945){return a540_0x524f=function(_0x4eed52,_0x524fea){_0x4eed52=_0x4eed52-0x6a;let _0x1ba84b=a540_0x4eed[_0x4eed52];return _0x1ba84b;},a540_0x524f(_0x13617b,_0x350945);}var __decorate=this&&this[a540_0x323918(0x93)]||function(_0x3247ed,_0x499b99,_0x478869,_0x125ba5){const _0x27adfe=a540_0x323918;var _0x5ddac7=arguments['length'],_0x4fef75=_0x5ddac7<0x3?_0x499b99:_0x125ba5===null?_0x125ba5=Object[_0x27adfe(0x76)](_0x499b99,_0x478869):_0x125ba5,_0x46e4c4;if(typeof Reflect===_0x27adfe(0x75)&&typeof Reflect['decorate']===_0x27adfe(0x72))_0x4fef75=Reflect[_0x27adfe(0x9a)](_0x3247ed,_0x499b99,_0x478869,_0x125ba5);else{for(var _0x117992=_0x3247ed['length']-0x1;_0x117992>=0x0;_0x117992--)if(_0x46e4c4=_0x3247ed[_0x117992])_0x4fef75=(_0x5ddac7<0x3?_0x46e4c4(_0x4fef75):_0x5ddac7>0x3?_0x46e4c4(_0x499b99,_0x478869,_0x4fef75):_0x46e4c4(_0x499b99,_0x478869))||_0x4fef75;}return _0x5ddac7>0x3&&_0x4fef75&&Object['defineProperty'](_0x499b99,_0x478869,_0x4fef75),_0x4fef75;},__metadata=this&&this[a540_0x323918(0xa8)]||function(_0x5bc790,_0xbb7a51){const _0x2d2c79=a540_0x323918;if(typeof Reflect===_0x2d2c79(0x75)&&typeof Reflect['metadata']===_0x2d2c79(0x72))return Reflect[_0x2d2c79(0x7c)](_0x5bc790,_0xbb7a51);},__param=this&&this[a540_0x323918(0x79)]||function(_0x4770fe,_0x604180){return function(_0x49d7eb,_0x25fb25){_0x604180(_0x49d7eb,_0x25fb25,_0x4770fe);};};Object[a540_0x323918(0x73)](exports,a540_0x323918(0x84),{'value':!![]}),exports[a540_0x323918(0x71)]=void 0x0;const common_1=require(a540_0x323918(0x80)),kernel_1=require(a540_0x323918(0x6a)),mongoose_1=require(a540_0x323918(0xaa)),socket_user_service_1=require(a540_0x323918(0x74)),constant_1=require('../constant'),services_1=require(a540_0x323918(0x6b)),services_2=require(a540_0x323918(0xac)),services_3=require(a540_0x323918(0x70)),string_helper_1=require(a540_0x323918(0x82)),stream_provider_1=require(a540_0x323918(0x6d)),services_4=require('../services'),USER_LIVE_STREAM_DISCONNECTED=a540_0x323918(0xa6),MODEL_LIVE_STREAM_DISCONNECTED=a540_0x323918(0xa4),USER_LEFT_ROOM='USER_LEFT_ROOM';let StreamConnectListener=class StreamConnectListener{constructor(_0x3a85ab,_0x1d4322,_0x183a71,_0x53efdc,_0x234d90,_0x3a3af8,_0x12adc8){const _0x125b28=a540_0x323918;this[_0x125b28(0x95)]=_0x3a85ab,this['userService']=_0x1d4322,this[_0x125b28(0x6e)]=_0x183a71,this[_0x125b28(0x9e)]=_0x53efdc,this[_0x125b28(0x81)]=_0x234d90,this[_0x125b28(0xab)]=_0x3a3af8,this['streamModel']=_0x12adc8,this[_0x125b28(0x95)][_0x125b28(0x96)](constant_1[_0x125b28(0x98)],USER_LIVE_STREAM_DISCONNECTED,this[_0x125b28(0x9b)]['bind'](this)),this[_0x125b28(0x95)][_0x125b28(0x96)](constant_1[_0x125b28(0x90)],MODEL_LIVE_STREAM_DISCONNECTED,this[_0x125b28(0x97)]['bind'](this));}['leftRoom'](_0x46b63d,_0x331e18,_0x5cb726=!![]){const _0x5e96bb=a540_0x323918,{_id:_0x3e11e1,type:_0x19b0eb}=_0x46b63d,_0x1024a3=this[_0x5e96bb(0xab)]['serializeConversation'](_0x3e11e1,_0x19b0eb);return Promise[_0x5e96bb(0x8b)]([this[_0x5e96bb(0x9e)][_0x5e96bb(0x8e)](_0x1024a3,_0x5e96bb(0xa3)+_0x3e11e1,{'_id':string_helper_1['generateUuid'](),'text':_0x331e18+_0x5e96bb(0x8d),'conversationId':_0x3e11e1,'isSystem':!![]}),_0x5cb726&&this[_0x5e96bb(0x9e)][_0x5e96bb(0x8e)](_0x1024a3,USER_LEFT_ROOM,{'username':_0x331e18,'conversationId':_0x3e11e1})]);}async[a540_0x323918(0x9b)](_0x24f7fd){const _0x15e064=a540_0x323918;if(_0x24f7fd['eventName']!==constant_1['LIVE_STREAM_EVENT_NAME']['DISCONNECTED'])return;const _0x6952e1=_0x24f7fd[_0x15e064(0x8f)],_0x223ddb=await this[_0x15e064(0x88)][_0x15e064(0x8a)](_0x6952e1);if(!_0x223ddb)return;const _0x50e47e=await this['socketUserService'][_0x15e064(0x7d)](_0x6952e1);if(!_0x50e47e[_0x15e064(0x6c)])return;await Promise[_0x15e064(0x8b)](_0x50e47e[_0x15e064(0x9d)](_0x33b3bc=>this[_0x15e064(0x9e)][_0x15e064(0xa2)](_0x33b3bc,_0x6952e1)));const _0x132933=_0x50e47e['map'](_0x3bc493=>this[_0x15e064(0xab)][_0x15e064(0xa7)](_0x3bc493)),_0xdf5bf=await this[_0x15e064(0xab)][_0x15e064(0xa5)](_0x132933);_0xdf5bf[_0x15e064(0x6c)]&&await Promise[_0x15e064(0x8b)](_0xdf5bf['map'](_0x560627=>this[_0x15e064(0x7b)](_0x560627,_0x223ddb[_0x15e064(0x8c)])));}async[a540_0x323918(0x97)](_0x1d738d){const _0x47fb78=a540_0x323918;if(_0x1d738d['eventName']!==constant_1['LIVE_STREAM_EVENT_NAME'][_0x47fb78(0x9f)])return;const _0x46a074=_0x1d738d[_0x47fb78(0x8f)],_0x52811d=await this['performerService'][_0x47fb78(0x8a)](_0x46a074);if(!_0x52811d)return;const _0x3c0a08=await this[_0x47fb78(0x9e)][_0x47fb78(0x7d)](_0x46a074);if(!_0x3c0a08[_0x47fb78(0x6c)])return;await Promise[_0x47fb78(0x8b)](_0x3c0a08[_0x47fb78(0x9d)](_0x52ef18=>this['socketUserService'][_0x47fb78(0xa2)](_0x52ef18,_0x46a074)));const _0x27446b=_0x3c0a08['map'](_0x1db64a=>this[_0x47fb78(0xab)][_0x47fb78(0xa7)](_0x1db64a)),_0x1a854e=await this[_0x47fb78(0xab)][_0x47fb78(0xa5)](_0x27446b);_0x1a854e[_0x47fb78(0x6c)]&&await Promise[_0x47fb78(0x8b)](_0x1a854e['map'](_0x51adcd=>this[_0x47fb78(0x7b)](_0x51adcd,_0x52811d['username'],![]))),await this['streamModel'][_0x47fb78(0x9c)]({'isStreaming':!![]},{'$set':{'isStreaming':![],'lastStreamingTime':new Date()}});}};StreamConnectListener=__decorate([common_1[a540_0x323918(0x77)](),__param(0x6,common_1[a540_0x323918(0xa0)](stream_provider_1[a540_0x323918(0x92)])),__metadata(a540_0x323918(0xa1),[kernel_1[a540_0x323918(0x91)],services_1['UserService'],services_2[a540_0x323918(0x7f)],socket_user_service_1[a540_0x323918(0x78)],services_4['StreamService'],services_3[a540_0x323918(0x89)],mongoose_1['Model']])],StreamConnectListener),exports[a540_0x323918(0x71)]=StreamConnectListener;