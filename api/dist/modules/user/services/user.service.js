'use strict';const a625_0x4258=['ACTIVE','../../settings/constants','email','countDocuments','../exceptions','updateBalance','fileService','name','findByIds','__decorate','../exceptions/username-existed.exception','__esModule','username','SHIPPING_INFO_PROVIDER','1118574EaGGgN','ROLE','16927fuGOBT','metadata','UsernameExistedException','357781emBEJX','UserService','total','Model','status','../../file/services','465523OdHYVr','updateStats','findById','../../../kernel','adminUpdate','__param','../dtos','find','64SDtMfC','create','../constants','SettingService','../providers','1AErztr','_id','1402885vMDQKW','path','decorate','join','emailVerified','EntityNotFoundException','../../settings','forwardRef','roles','shippingInfoModel','STATUS_ACTIVE','updateOne','updateAvatar','aggregate','3bjREWs','FileService','trim','update','getShippingInfo','object','STATUS','user','findOne','__metadata','firstName','length','mongoose','updateVerificationStatus','getOwnPropertyDescriptor','findByUsername','SETTING_KEYS','Injectable','userModel','toLowerCase','createShippingInfo','getKeyValue','avatarId','function','all','assign','Inject','map','lastName','UserDto','400349ghtWxn','settingService','1wYydhS','1089898VHjSJp','defineProperty','findByEmail'];const a625_0x4364d0=a625_0x4591;(function(_0x1fd674,_0x2a99ea){const _0x29a473=a625_0x4591;while(!![]){try{const _0x3f3e0b=-parseInt(_0x29a473(0x1d8))+-parseInt(_0x29a473(0x1ee))*parseInt(_0x29a473(0x1a5))+parseInt(_0x29a473(0x19d))*parseInt(_0x29a473(0x1da))+parseInt(_0x29a473(0x1db))+parseInt(_0x29a473(0x1aa))*-parseInt(_0x29a473(0x1ac))+parseInt(_0x29a473(0x1ec))+-parseInt(_0x29a473(0x197))*-parseInt(_0x29a473(0x1ba));if(_0x3f3e0b===_0x2a99ea)break;else _0x1fd674['push'](_0x1fd674['shift']());}catch(_0x2641e0){_0x1fd674['push'](_0x1fd674['shift']());}}}(a625_0x4258,0xd2268));function a625_0x4591(_0x31b968,_0x4ba55b){return a625_0x4591=function(_0x425890,_0x45915f){_0x425890=_0x425890-0x195;let _0x5c1c7b=a625_0x4258[_0x425890];return _0x5c1c7b;},a625_0x4591(_0x31b968,_0x4ba55b);}var __decorate=this&&this[a625_0x4364d0(0x1e7)]||function(_0x505809,_0x14d0d8,_0x12e2a1,_0x45c44b){const _0x7c9796=a625_0x4364d0;var _0x5acbb6=arguments[_0x7c9796(0x1c5)],_0x9af525=_0x5acbb6<0x3?_0x14d0d8:_0x45c44b===null?_0x45c44b=Object[_0x7c9796(0x1c8)](_0x14d0d8,_0x12e2a1):_0x45c44b,_0x33b80c;if(typeof Reflect===_0x7c9796(0x1bf)&&typeof Reflect['decorate']===_0x7c9796(0x1d1))_0x9af525=Reflect[_0x7c9796(0x1ae)](_0x505809,_0x14d0d8,_0x12e2a1,_0x45c44b);else{for(var _0x20903a=_0x505809[_0x7c9796(0x1c5)]-0x1;_0x20903a>=0x0;_0x20903a--)if(_0x33b80c=_0x505809[_0x20903a])_0x9af525=(_0x5acbb6<0x3?_0x33b80c(_0x9af525):_0x5acbb6>0x3?_0x33b80c(_0x14d0d8,_0x12e2a1,_0x9af525):_0x33b80c(_0x14d0d8,_0x12e2a1))||_0x9af525;}return _0x5acbb6>0x3&&_0x9af525&&Object[_0x7c9796(0x1dc)](_0x14d0d8,_0x12e2a1,_0x9af525),_0x9af525;},__metadata=this&&this[a625_0x4364d0(0x1c3)]||function(_0x1c0b2e,_0x49dd9e){const _0x3bb690=a625_0x4364d0;if(typeof Reflect==='object'&&typeof Reflect[_0x3bb690(0x195)]===_0x3bb690(0x1d1))return Reflect[_0x3bb690(0x195)](_0x1c0b2e,_0x49dd9e);},__param=this&&this[a625_0x4364d0(0x1a2)]||function(_0x34d2e5,_0x8ad921){return function(_0x5cd6f3,_0x38b9d6){_0x8ad921(_0x5cd6f3,_0x38b9d6,_0x34d2e5);};};Object[a625_0x4364d0(0x1dc)](exports,a625_0x4364d0(0x1e9),{'value':!![]}),exports[a625_0x4364d0(0x198)]=void 0x0;const common_1=require('@nestjs/common'),mongoose_1=require(a625_0x4364d0(0x1c6)),file_1=require('../../file'),kernel_1=require(a625_0x4364d0(0x1a0)),constants_1=require('../../../kernel/constants'),services_1=require(a625_0x4364d0(0x19c)),settings_1=require(a625_0x4364d0(0x1b2)),constants_2=require(a625_0x4364d0(0x1df)),providers_1=require(a625_0x4364d0(0x1a9)),dtos_1=require(a625_0x4364d0(0x1a3)),constants_3=require(a625_0x4364d0(0x1a7)),exceptions_1=require(a625_0x4364d0(0x1e2)),username_existed_exception_1=require(a625_0x4364d0(0x1e8));let UserService=class UserService{constructor(_0x41d057,_0x3aba99,_0x41a51d,_0x441a89){const _0x1a7e49=a625_0x4364d0;this['userModel']=_0x41d057,this[_0x1a7e49(0x1b5)]=_0x3aba99,this[_0x1a7e49(0x1e4)]=_0x41a51d,this[_0x1a7e49(0x1d9)]=_0x441a89;}async['find'](_0x6188ca){const _0x117b45=a625_0x4364d0;return this[_0x117b45(0x1cc)]['find'](_0x6188ca);}async[a625_0x4364d0(0x1dd)](_0x9f1e98){const _0x1c0861=a625_0x4364d0;return this[_0x1c0861(0x1cc)][_0x1c0861(0x1c2)]({'email':_0x9f1e98[_0x1c0861(0x1cd)]()});}async['findByEmails'](_0x292abd){const _0x2d9bf1=a625_0x4364d0;return this[_0x2d9bf1(0x1cc)]['find']({'email':{'$in':_0x292abd}});}async['findById'](_0x347940){const _0x3d5586=a625_0x4364d0;return this['userModel'][_0x3d5586(0x19f)](_0x347940);}async[a625_0x4364d0(0x1c9)](_0x200006){const _0x35cc08=a625_0x4364d0,_0x59cff9=_0x200006[_0x35cc08(0x1cd)](),_0x4f5e8a=await this[_0x35cc08(0x1cc)][_0x35cc08(0x1c2)]({'username':_0x59cff9});return _0x4f5e8a?new dtos_1[(_0x35cc08(0x1d7))](_0x4f5e8a):null;}async[a625_0x4364d0(0x1e6)](_0x3cd6a4){const _0x18233d=a625_0x4364d0,_0x23ada4=await this['userModel']['find']({'_id':{'$in':_0x3cd6a4}});return _0x23ada4[_0x18233d(0x1d5)](_0x55031f=>new dtos_1[(_0x18233d(0x1d7))](_0x55031f));}async['create'](_0x42790e,_0x2e1f21={}){const _0x1324ed=a625_0x4364d0,_0x4697e7=await this[_0x1324ed(0x1cc)][_0x1324ed(0x1e1)]({'email':_0x42790e[_0x1324ed(0x1e0)][_0x1324ed(0x1cd)]()});if(_0x4697e7)throw new exceptions_1['EmailHasBeenTakenException']();const _0x1bacd0=await this[_0x1324ed(0x1c9)](_0x42790e['username']);if(_0x1bacd0)throw new username_existed_exception_1[(_0x1324ed(0x196))]();const _0x4038c3=await this[_0x1324ed(0x1d9)][_0x1324ed(0x1cf)](constants_2[_0x1324ed(0x1ca)]['FREE_TOKENS'])||0x0,_0x3c8556=Object[_0x1324ed(0x1d3)](Object[_0x1324ed(0x1d3)]({},_0x42790e),{'balance':_0x4038c3});return _0x3c8556['createdAt']=new Date(),_0x3c8556['updatedAt']=new Date(),_0x3c8556[_0x1324ed(0x1b4)]=_0x2e1f21[_0x1324ed(0x1b4)]||[_0x1324ed(0x1c1)],_0x3c8556['status']=_0x2e1f21[_0x1324ed(0x19b)]||constants_3[_0x1324ed(0x1b6)],typeof _0x2e1f21[_0x1324ed(0x1b0)]!=='undefined'&&(_0x3c8556[_0x1324ed(0x1b0)]=_0x2e1f21[_0x1324ed(0x1b0)]),!_0x3c8556[_0x1324ed(0x1e5)]&&(_0x3c8556[_0x1324ed(0x1e5)]=[_0x3c8556[_0x1324ed(0x1c4)]||'',_0x3c8556['lastName']||'']['join']('\x20')[_0x1324ed(0x1bc)]()),this[_0x1324ed(0x1cc)]['create'](_0x3c8556);}async[a625_0x4364d0(0x1bd)](_0x2eaa75,_0x4d360a,_0x5f2809){const _0x55df44=a625_0x4364d0,_0x13d7b9=Object[_0x55df44(0x1d3)]({},_0x4d360a);return _0x5f2809&&''+_0x5f2809[_0x55df44(0x1ab)]===''+_0x2eaa75&&(delete _0x13d7b9[_0x55df44(0x1e0)],delete _0x13d7b9[_0x55df44(0x1ea)]),!_0x5f2809['name']&&(_0x13d7b9[_0x55df44(0x1e5)]=[_0x5f2809[_0x55df44(0x1c4)]||'',_0x5f2809[_0x55df44(0x1d6)]||''][_0x55df44(0x1af)]('\x20')['trim']()),this[_0x55df44(0x1cc)][_0x55df44(0x1b7)]({'_id':_0x2eaa75},_0x13d7b9,{'new':!![]});}async[a625_0x4364d0(0x1b8)](_0x24e63f,_0x34720b){const _0x3f6c6f=a625_0x4364d0;return await this['userModel'][_0x3f6c6f(0x1b7)]({'_id':_0x24e63f['_id']},{'avatarId':_0x34720b[_0x3f6c6f(0x1ab)],'avatarPath':_0x34720b[_0x3f6c6f(0x1ad)]}),_0x24e63f['avatarId']&&_0x24e63f[_0x3f6c6f(0x1d0)]!==_0x34720b['_id']&&await this['fileService']['remove'](_0x24e63f['avatarId']),await this[_0x3f6c6f(0x1e4)]['addRef'](_0x34720b[_0x3f6c6f(0x1ab)],{'itemId':_0x24e63f[_0x3f6c6f(0x1ab)],'itemType':constants_1[_0x3f6c6f(0x1ed)]['USER']}),_0x34720b;}async[a625_0x4364d0(0x1a1)](_0x355bd0,_0x4ac36c){const _0x45e415=a625_0x4364d0,_0xf507c3=await this[_0x45e415(0x1cc)][_0x45e415(0x19f)](_0x355bd0);if(!_0xf507c3)throw new kernel_1[(_0x45e415(0x1b1))]();const _0x25759f=Object[_0x45e415(0x1d3)]({},_0x4ac36c);!_0xf507c3[_0x45e415(0x1e5)]&&(_0xf507c3['name']=[_0xf507c3['firstName']||'',_0xf507c3[_0x45e415(0x1d6)]||'']['join']('\x20')[_0x45e415(0x1bc)]());if(_0x25759f['email']&&_0x25759f[_0x45e415(0x1e0)][_0x45e415(0x1cd)]()!==_0xf507c3[_0x45e415(0x1e0)][_0x45e415(0x1cd)]()){const _0x150c4d=await this[_0x45e415(0x1cc)][_0x45e415(0x1e1)]({'email':_0x25759f[_0x45e415(0x1e0)][_0x45e415(0x1cd)](),'_id':{'$ne':_0xf507c3[_0x45e415(0x1ab)]}});if(_0x150c4d)throw new exceptions_1['EmailHasBeenTakenException']();}if(_0x25759f[_0x45e415(0x1ea)]&&_0x25759f[_0x45e415(0x1ea)][_0x45e415(0x1cd)]()!==_0xf507c3[_0x45e415(0x1ea)][_0x45e415(0x1cd)]()){const _0x1c8160=await this[_0x45e415(0x1cc)][_0x45e415(0x1e1)]({'username':_0xf507c3['username'][_0x45e415(0x1cd)](),'_id':{'$ne':_0xf507c3[_0x45e415(0x1ab)]}});if(_0x1c8160)throw new username_existed_exception_1[(_0x45e415(0x196))]();}return this['userModel'][_0x45e415(0x1b7)]({'_id':_0x355bd0},_0x25759f,{'new':!![]});}async[a625_0x4364d0(0x1ce)](_0xae3f89,_0x1a4e34){const _0x4c8dbe=a625_0x4364d0,_0x212abe=await this['shippingInfoModel'][_0x4c8dbe(0x1a6)](Object[_0x4c8dbe(0x1d3)](_0x1a4e34,{'userId':_0xae3f89[_0x4c8dbe(0x1ab)]}));return _0x212abe;}async[a625_0x4364d0(0x1be)](_0x3306eb){const _0x449908=a625_0x4364d0,[_0xa6f384,_0x5e7244]=await Promise[_0x449908(0x1d2)]([this[_0x449908(0x1b5)][_0x449908(0x1e1)]({'userId':_0x3306eb}),this[_0x449908(0x1b5)][_0x449908(0x1a4)]({'userId':_0x3306eb})]);return{'data':_0x5e7244,'total':_0xa6f384};}async[a625_0x4364d0(0x1c7)](_0x1bdfec){const _0x2c97a4=a625_0x4364d0;return this[_0x2c97a4(0x1cc)]['updateOne']({'_id':_0x1bdfec},{'status':constants_1[_0x2c97a4(0x1c0)][_0x2c97a4(0x1de)],'emailVerified':!![]},{'new':!![]});}async[a625_0x4364d0(0x1e3)](_0x5d7222,_0x3ea53f,_0x565244=!![]){const _0x3aa0c5=a625_0x4364d0,_0x59820d=_0x565244?{'balance':_0x3ea53f,'stats.totalTokenEarned':_0x3ea53f>0x0?_0x3ea53f:0x0,'stats.totalTokenSpent':_0x3ea53f<=0x0?_0x3ea53f:0x0}:{'balance':_0x3ea53f};return this[_0x3aa0c5(0x1cc)]['updateOne']({'_id':_0x5d7222},{'$inc':_0x59820d});}async[a625_0x4364d0(0x19e)](_0x5da230,_0x45d86e){const _0xd6436e=a625_0x4364d0;return this[_0xd6436e(0x1cc)][_0xd6436e(0x1b7)]({'_id':_0x5da230},{'$inc':_0x45d86e});}async['stats'](){const _0x2e4345=a625_0x4364d0,[_0x548af4,_0x20c32a]=await Promise[_0x2e4345(0x1d2)]([this[_0x2e4345(0x1cc)][_0x2e4345(0x1b9)]([{'$group':{'_id':null,'total':{'$sum':'$stats.totalViewTime'}}}]),this['userModel'][_0x2e4345(0x1b9)]([{'$group':{'_id':null,'total':{'$sum':'$stats.totalTokenSpent'}}}])]);return{'totalViewTime':_0x548af4[_0x2e4345(0x1c5)]&&_0x548af4[0x0][_0x2e4345(0x199)]||0x0,'totalTokenSpent':_0x20c32a[_0x2e4345(0x1c5)]&&_0x20c32a[0x0][_0x2e4345(0x199)]||0x0};}};UserService=__decorate([common_1[a625_0x4364d0(0x1cb)](),__param(0x0,common_1[a625_0x4364d0(0x1d4)](providers_1['USER_MODEL_PROVIDER'])),__param(0x1,common_1['Inject'](providers_1[a625_0x4364d0(0x1eb)])),__param(0x2,common_1[a625_0x4364d0(0x1d4)](common_1[a625_0x4364d0(0x1b3)](()=>services_1['FileService']))),__metadata('design:paramtypes',[mongoose_1['Model'],mongoose_1[a625_0x4364d0(0x19a)],services_1[a625_0x4364d0(0x1bb)],settings_1[a625_0x4364d0(0x1a8)]])],UserService),exports[a625_0x4364d0(0x198)]=UserService;