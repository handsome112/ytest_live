'use strict';const a420_0xecbd=['1441696jXqLJH','DELETED','toLowerCase','getDetails','_id','isSaleVideo','paymentTokenService','map','618066fPBLvA','1fxrZqV','FILE_PROCESSED','toPublicDetailsResponse','VIDEO_PROCSSED','../../user/dtos','isBought','trailerId','446351gzBXjJ','../../file/services','fileService','createdBy','@nestjs/common','save','length','thumbnailId','Inject','__param','pop','Invalid\x20file\x20format','VideoService','includes','mongoose','getOwnPropertyDescriptor','PERFORMER_VIDEO_CHANNEL','fileId','../providers','QueueEvent','trailer','username','isImage','../../auth/services','CREATED','publish','performer-trailer-video','find','__metadata','../../../kernel/constants','getPublicUrl','MEDIA_FILE_CHANNEL','all','PerformerService','handleFileProcessed','processing','subscribe','toObject','remove','EntityNotFoundException','duration','QueueEventService','addRef','status','lean','VideoModel','exec','../../performer/services','push','AuthService','split','toLocaleLowerCase','updateOne','../../purchased-item/services','updatedBy','defineProperty','thumbnail','metadata','video','2497mAjhSc','performerService','mimeType','userGetDetails','checkBoughtVideo','EVENT','Injectable','VideoDto','getUrl','FILE_EVENT','VIDEO_STATUS','../constants','../../performer/dtos','lodash','performer','updateInfo','queueEventService','create','name','meta','performerId','set','284BuMEiM','createdAt','../../../kernel','__decorate','decorate','queueProcessVideo','FILE_ERROR','checkAuth','253080SZbJlk','findById','UPDATED','629751KPsChK','merge','findOne','performer-video-thumbnail','data','error','performer-video','roles','updatedAt','?videoId=','object','mkv','FileService','../../file','assign','PaymentTokenService','FileDto','getVideoForView','forwardRef','59210OtERNI','path','authService','toString'];const a420_0x2b8046=a420_0x46cb;(function(_0xc2f622,_0x2e6b41){const _0x2ee231=a420_0x46cb;while(!![]){try{const _0x45d3ea=-parseInt(_0x2ee231(0x143))+parseInt(_0x2ee231(0x119))+parseInt(_0x2ee231(0x17e))*parseInt(_0x2ee231(0x194))+parseInt(_0x2ee231(0x11c))+-parseInt(_0x2ee231(0x13b))*-parseInt(_0x2ee231(0x13c))+parseInt(_0x2ee231(0x12f))+-parseInt(_0x2ee231(0x133));if(_0x45d3ea===_0x2e6b41)break;else _0xc2f622['push'](_0xc2f622['shift']());}catch(_0x12a08a){_0xc2f622['push'](_0xc2f622['shift']());}}}(a420_0xecbd,0x5d118));var __decorate=this&&this[a420_0x2b8046(0x197)]||function(_0x29fbf3,_0x3cce69,_0x3ab75b,_0x1c7c52){const _0x510e6a=a420_0x2b8046;var _0x4e21b2=arguments[_0x510e6a(0x149)],_0x5c0d25=_0x4e21b2<0x3?_0x3cce69:_0x1c7c52===null?_0x1c7c52=Object[_0x510e6a(0x152)](_0x3cce69,_0x3ab75b):_0x1c7c52,_0x3edda9;if(typeof Reflect===_0x510e6a(0x126)&&typeof Reflect['decorate']==='function')_0x5c0d25=Reflect[_0x510e6a(0x198)](_0x29fbf3,_0x3cce69,_0x3ab75b,_0x1c7c52);else{for(var _0x46866f=_0x29fbf3[_0x510e6a(0x149)]-0x1;_0x46866f>=0x0;_0x46866f--)if(_0x3edda9=_0x29fbf3[_0x46866f])_0x5c0d25=(_0x4e21b2<0x3?_0x3edda9(_0x5c0d25):_0x4e21b2>0x3?_0x3edda9(_0x3cce69,_0x3ab75b,_0x5c0d25):_0x3edda9(_0x3cce69,_0x3ab75b))||_0x5c0d25;}return _0x4e21b2>0x3&&_0x5c0d25&&Object[_0x510e6a(0x17a)](_0x3cce69,_0x3ab75b,_0x5c0d25),_0x5c0d25;},__metadata=this&&this[a420_0x2b8046(0x15f)]||function(_0xb7f1ec,_0x480038){const _0x1e8943=a420_0x2b8046;if(typeof Reflect==='object'&&typeof Reflect[_0x1e8943(0x17c)]==='function')return Reflect[_0x1e8943(0x17c)](_0xb7f1ec,_0x480038);},__param=this&&this[a420_0x2b8046(0x14c)]||function(_0x331fb7,_0x41db2d){return function(_0x5e3e36,_0x1340bf){_0x41db2d(_0x5e3e36,_0x1340bf,_0x331fb7);};};function a420_0x46cb(_0x3760d7,_0x791f4){return a420_0x46cb=function(_0xecbd04,_0x46cb57){_0xecbd04=_0xecbd04-0x119;let _0x1dbfae=a420_0xecbd[_0xecbd04];return _0x1dbfae;},a420_0x46cb(_0x3760d7,_0x791f4);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports['VideoService']=void 0x0;const common_1=require(a420_0x2b8046(0x147)),mongoose_1=require(a420_0x2b8046(0x151)),kernel_1=require(a420_0x2b8046(0x196)),file_1=require(a420_0x2b8046(0x129)),dtos_1=require(a420_0x2b8046(0x140)),dtos_2=require(a420_0x2b8046(0x18a)),services_1=require(a420_0x2b8046(0x144)),services_2=require(a420_0x2b8046(0x172)),lodash_1=require(a420_0x2b8046(0x18b)),constants_1=require(a420_0x2b8046(0x160)),services_3=require(a420_0x2b8046(0x15a)),services_4=require(a420_0x2b8046(0x178)),dtos_3=require('../dtos'),constants_2=require(a420_0x2b8046(0x189)),providers_1=require(a420_0x2b8046(0x155)),FILE_PROCESSED_TOPIC=a420_0x2b8046(0x13d);let VideoService=class VideoService{constructor(_0x534e83,_0x5b993b,_0x38c6bf,_0x10d856,_0x15ad47,_0x3bfd7f){const _0x195673=a420_0x2b8046;this[_0x195673(0x170)]=_0x534e83,this[_0x195673(0x18e)]=_0x5b993b,this[_0x195673(0x145)]=_0x38c6bf,this[_0x195673(0x17f)]=_0x10d856,this[_0x195673(0x131)]=_0x15ad47,this[_0x195673(0x139)]=_0x3bfd7f,this['queueEventService'][_0x195673(0x167)](constants_2[_0x195673(0x153)],FILE_PROCESSED_TOPIC,this[_0x195673(0x165)]['bind'](this));}async['findByIds'](_0x55dda3){const _0x1653cf=a420_0x2b8046,_0x39d08d=await this['VideoModel'][_0x1653cf(0x15e)]({'_id':{'$in':_0x55dda3}})[_0x1653cf(0x16f)]()[_0x1653cf(0x171)]();return _0x39d08d[_0x1653cf(0x13a)](_0x152f80=>new dtos_3[(_0x1653cf(0x185))](_0x152f80));}async['findById'](_0x1800a4){const _0x584404=a420_0x2b8046,_0x5a63ca=await this[_0x584404(0x170)][_0x584404(0x11e)]({'_id':_0x1800a4})['lean']()[_0x584404(0x171)]();return new dtos_3[(_0x584404(0x185))](_0x5a63ca);}async[a420_0x2b8046(0x165)](_0x317738){const _0x1843bf=a420_0x2b8046;try{const {eventName:_0x930135}=_0x317738;if(_0x930135!==services_1[_0x1843bf(0x187)][_0x1843bf(0x13f)])return;const {videoId:_0x4933eb}=_0x317738[_0x1843bf(0x120)][_0x1843bf(0x191)],[_0x536d83,_0x38f750]=await Promise[_0x1843bf(0x163)]([this[_0x1843bf(0x170)][_0x1843bf(0x11a)](_0x4933eb),this[_0x1843bf(0x145)]['findById'](_0x317738['data']['fileId'])]);if(!_0x536d83)return;const _0x7628a0=_0x536d83[_0x1843bf(0x16e)];_0x536d83[_0x1843bf(0x166)]=![],_0x38f750[_0x1843bf(0x16e)]===_0x1843bf(0x121)&&(_0x536d83[_0x1843bf(0x16e)]=constants_2['VIDEO_STATUS']['FILE_ERROR']),await _0x536d83['save'](),await this[_0x1843bf(0x18e)][_0x1843bf(0x15c)](new kernel_1[(_0x1843bf(0x156))]({'channel':constants_2['PERFORMER_VIDEO_CHANNEL'],'eventName':constants_1[_0x1843bf(0x183)][_0x1843bf(0x11b)],'data':Object['assign'](Object[_0x1843bf(0x12a)]({},new dtos_3[(_0x1843bf(0x185))](_0x536d83)),{'oldStatus':_0x7628a0})}));}catch(_0x3e11d6){console['log'](_0x3e11d6);}}[a420_0x2b8046(0x12d)](_0x1b07b0,_0x771e5b,_0x32f194){const _0x362eac=a420_0x2b8046;return{'url':_0x32f194?_0x1b07b0[_0x362eac(0x186)]()+_0x362eac(0x125)+_0x771e5b+'&token='+_0x32f194:_0x1b07b0[_0x362eac(0x186)]()+_0x362eac(0x125)+_0x771e5b,'duration':_0x1b07b0[_0x362eac(0x16b)],'thumbnails':(_0x1b07b0['thumbnails']||[])[_0x362eac(0x13a)](_0x95e45=>file_1[_0x362eac(0x12c)][_0x362eac(0x161)](_0x95e45[_0x362eac(0x130)]))};}async[a420_0x2b8046(0x18f)](_0x7ca813,_0x3de8ff,_0x1ed0cc,_0x2a6384,_0x594f20){const _0x107fd9=a420_0x2b8046;let _0xf89555=!![];if(!_0x7ca813)_0xf89555=![];!_0xf89555&&_0x1ed0cc&&await this[_0x107fd9(0x145)][_0x107fd9(0x169)](_0x1ed0cc['_id']);_0x1ed0cc&&!_0x1ed0cc[_0x107fd9(0x159)]()&&await this['fileService']['remove'](_0x1ed0cc['_id']);_0x7ca813&&!_0x7ca813[_0x107fd9(0x180)]['toLowerCase']()[_0x107fd9(0x150)](_0x107fd9(0x17d))&&(_0x7ca813['name']['split']('.')['pop']()||'')['toLocaleLowerCase']()!==_0x107fd9(0x127)&&await this[_0x107fd9(0x145)][_0x107fd9(0x169)](_0x7ca813['_id']);_0x3de8ff&&!_0x3de8ff[_0x107fd9(0x180)][_0x107fd9(0x135)]()[_0x107fd9(0x150)](_0x107fd9(0x17d))&&(_0x3de8ff[_0x107fd9(0x190)][_0x107fd9(0x175)]('.')[_0x107fd9(0x14d)]()||'')[_0x107fd9(0x176)]()!==_0x107fd9(0x127)&&await this[_0x107fd9(0x145)][_0x107fd9(0x169)](_0x3de8ff[_0x107fd9(0x137)]);if(!_0xf89555)throw new Error(_0x107fd9(0x14e));const _0x3185c1=new this[(_0x107fd9(0x170))](_0x2a6384);return _0x3185c1[_0x107fd9(0x154)]=_0x7ca813[_0x107fd9(0x137)],_0x3185c1[_0x107fd9(0x14a)]=_0x1ed0cc?_0x1ed0cc[_0x107fd9(0x137)]:null,_0x3185c1['trailerId']=_0x3de8ff?_0x3de8ff['_id']:null,_0x3185c1['processing']=!![],_0x594f20&&_0x3185c1[_0x107fd9(0x193)](_0x107fd9(0x146),_0x594f20[_0x107fd9(0x137)]),_0x3185c1[_0x107fd9(0x195)]=new Date(),_0x3185c1[_0x107fd9(0x124)]=new Date(),await _0x3185c1[_0x107fd9(0x148)](),_0x3185c1[_0x107fd9(0x14a)]&&await this['fileService']['addRef'](_0x3185c1[_0x107fd9(0x14a)],{'itemId':_0x3185c1[_0x107fd9(0x137)],'itemType':_0x107fd9(0x11f)}),_0x3185c1['fileId']&&await this['fileService'][_0x107fd9(0x16d)](_0x3185c1[_0x107fd9(0x154)],{'itemType':_0x107fd9(0x122),'itemId':_0x3185c1[_0x107fd9(0x137)]}),_0x3185c1[_0x107fd9(0x142)]&&await this['fileService'][_0x107fd9(0x16d)](_0x3185c1[_0x107fd9(0x142)],{'itemType':_0x107fd9(0x15d),'itemId':_0x3185c1['_id']}),await this[_0x107fd9(0x18e)][_0x107fd9(0x15c)](new kernel_1[(_0x107fd9(0x156))]({'channel':constants_2[_0x107fd9(0x153)],'eventName':constants_1[_0x107fd9(0x183)][_0x107fd9(0x15b)],'data':new dtos_3['VideoDto'](_0x3185c1)})),await this[_0x107fd9(0x145)][_0x107fd9(0x199)](_0x3185c1[_0x107fd9(0x154)],{'publishChannel':constants_2[_0x107fd9(0x153)],'meta':{'videoId':_0x3185c1['_id']}}),new dtos_3['VideoDto'](_0x3185c1);}async[a420_0x2b8046(0x136)](_0x18985d,_0x1a7745){const _0x33a4e2=a420_0x2b8046,_0x180657=await this[_0x33a4e2(0x170)][_0x33a4e2(0x11a)](_0x18985d);if(!_0x180657)throw new kernel_1[(_0x33a4e2(0x16a))]();const [_0x43570b,_0x4c471a,_0x1f0b2c,_0x46786c]=await Promise[_0x33a4e2(0x163)]([this['performerService'][_0x33a4e2(0x11a)](_0x180657[_0x33a4e2(0x192)]),this[_0x33a4e2(0x145)][_0x33a4e2(0x11a)](_0x180657[_0x33a4e2(0x154)]),_0x180657['trailerId']?this['fileService'][_0x33a4e2(0x11a)](_0x180657[_0x33a4e2(0x142)]):null,_0x180657[_0x33a4e2(0x14a)]?this[_0x33a4e2(0x145)][_0x33a4e2(0x11a)](_0x180657[_0x33a4e2(0x14a)]):null]),_0x509e05=new dtos_3[(_0x33a4e2(0x185))](_0x180657);return _0x509e05[_0x33a4e2(0x17b)]=_0x46786c?_0x46786c['getUrl']():null,_0x509e05[_0x33a4e2(0x17d)]=this[_0x33a4e2(0x12d)](_0x4c471a,_0x509e05['_id'],_0x1a7745),_0x509e05[_0x33a4e2(0x157)]=_0x1f0b2c?this[_0x33a4e2(0x12d)](_0x1f0b2c,null,null):null,_0x509e05['performer']=_0x43570b?{'username':_0x43570b[_0x33a4e2(0x158)]}:null,_0x509e05;}async[a420_0x2b8046(0x181)](_0xf4dd9,_0x1cee57,_0x5a02f1){const _0x581057=a420_0x2b8046,_0x8a2719=await this[_0x581057(0x170)][_0x581057(0x11a)](_0xf4dd9);if(!_0x8a2719)throw new kernel_1[(_0x581057(0x16a))]();const [_0xbbe2c,_0x32e961,_0x17389c,_0x191e81]=await Promise[_0x581057(0x163)]([this[_0x581057(0x17f)][_0x581057(0x11a)](_0x8a2719[_0x581057(0x192)]),this[_0x581057(0x145)]['findById'](_0x8a2719[_0x581057(0x154)]),_0x8a2719[_0x581057(0x14a)]?this[_0x581057(0x145)][_0x581057(0x11a)](_0x8a2719[_0x581057(0x14a)]):null,_0x8a2719[_0x581057(0x142)]?this[_0x581057(0x145)][_0x581057(0x11a)](_0x8a2719[_0x581057(0x142)]):null]),_0x41a645=new dtos_3[(_0x581057(0x185))](_0x8a2719);_0x41a645[_0x581057(0x17b)]=_0x17389c?_0x17389c[_0x581057(0x186)]():null,_0x41a645['trailer']=_0x191e81?this[_0x581057(0x12d)](_0x191e81,null,null):null;if(!_0x41a645[_0x581057(0x138)])_0x41a645[_0x581057(0x17d)]=this[_0x581057(0x12d)](_0x32e961,_0x41a645['_id'],_0x5a02f1);else{const _0x15faf5=await this[_0x581057(0x139)]['checkBoughtVideo'](_0x41a645[_0x581057(0x137)],_0x1cee57);_0x41a645['video']=this[_0x581057(0x12d)](_0x32e961,_0x41a645[_0x581057(0x137)],_0x5a02f1),_0x41a645[_0x581057(0x141)]=_0x15faf5;}return _0x41a645[_0x581057(0x18c)]=_0xbbe2c?_0xbbe2c[_0x581057(0x13e)]():null,_0x41a645;}async['increaseView'](_0x2c10c1){const _0x23336b=a420_0x2b8046;return this[_0x23336b(0x170)][_0x23336b(0x177)]({'_id':_0x2c10c1},{'$inc':{'stats.views':0x1}},{'new':!![]});}async[a420_0x2b8046(0x18d)](_0x12cc61,_0x44ba8b,_0x2e1cee,_0x855101,_0x4542cd,_0x41233a){const _0x4037fd=a420_0x2b8046,_0x1940d5=await this['VideoModel'][_0x4037fd(0x11a)](_0x12cc61);if(!_0x1940d5)throw new kernel_1[(_0x4037fd(0x16a))]();const _0x42a34e=_0x1940d5[_0x4037fd(0x16e)];lodash_1[_0x4037fd(0x11d)](_0x1940d5,_0x44ba8b);_0x1940d5[_0x4037fd(0x16e)]!==constants_2[_0x4037fd(0x188)][_0x4037fd(0x19a)]&&_0x44ba8b[_0x4037fd(0x16e)]!==constants_2[_0x4037fd(0x188)][_0x4037fd(0x19a)]&&(_0x1940d5[_0x4037fd(0x16e)]=_0x44ba8b[_0x4037fd(0x16e)]);const _0x2c694e=[];_0x2e1cee&&(_0x1940d5[_0x4037fd(0x154)]&&_0x2c694e[_0x4037fd(0x173)](_0x1940d5[_0x4037fd(0x154)]),_0x1940d5['fileId']=_0x2e1cee[_0x4037fd(0x137)]);_0x855101&&(_0x1940d5['trailerId']&&_0x2c694e[_0x4037fd(0x173)](_0x1940d5['trailerId']),_0x1940d5[_0x4037fd(0x142)]=_0x855101[_0x4037fd(0x137)]);_0x4542cd&&(_0x1940d5[_0x4037fd(0x14a)]&&_0x2c694e['push'](_0x1940d5[_0x4037fd(0x14a)]),_0x1940d5[_0x4037fd(0x14a)]=_0x4542cd['_id']);_0x41233a&&_0x1940d5[_0x4037fd(0x193)](_0x4037fd(0x179),_0x41233a[_0x4037fd(0x137)]),_0x1940d5[_0x4037fd(0x124)]=new Date(),await _0x1940d5[_0x4037fd(0x148)](),_0x2c694e[_0x4037fd(0x149)]&&await Promise[_0x4037fd(0x163)](_0x2c694e['map'](_0x192fca=>this['fileService'][_0x4037fd(0x169)](_0x192fca)));const _0x4d8872=new dtos_3[(_0x4037fd(0x185))](_0x1940d5);return await this['queueEventService'][_0x4037fd(0x15c)](new kernel_1[(_0x4037fd(0x156))]({'channel':constants_2[_0x4037fd(0x153)],'eventName':constants_1[_0x4037fd(0x183)][_0x4037fd(0x11b)],'data':Object['assign'](Object[_0x4037fd(0x12a)]({},_0x4d8872),{'oldStatus':_0x42a34e})})),_0x4d8872;}async['delete'](_0x456723){const _0x45df23=a420_0x2b8046,_0x48c564=await this['VideoModel'][_0x45df23(0x11a)](_0x456723);if(!_0x48c564)throw new kernel_1[(_0x45df23(0x16a))]();return await _0x48c564[_0x45df23(0x169)](),await Promise['all']([this[_0x45df23(0x18e)][_0x45df23(0x15c)](new kernel_1[(_0x45df23(0x156))]({'channel':constants_2['PERFORMER_VIDEO_CHANNEL'],'eventName':constants_1[_0x45df23(0x183)][_0x45df23(0x134)],'data':new dtos_3[(_0x45df23(0x185))](_0x48c564)})),this[_0x45df23(0x18e)]['publish']({'channel':services_1[_0x45df23(0x162)],'eventName':services_1[_0x45df23(0x187)]['ASSETS_ITEM_DELETED'],'data':{'type':_0x45df23(0x17d),'metadata':_0x48c564[_0x45df23(0x168)]()}})]),!![];}async[a420_0x2b8046(0x19b)](_0x4ac2dd){const _0x200c8c=a420_0x2b8046,{query:{videoId:_0x51f83f,token:_0x314c27}}=_0x4ac2dd;if(!_0x51f83f)return![];const _0x3d3d1e=await this[_0x200c8c(0x170)][_0x200c8c(0x11a)](_0x51f83f);if(!_0x3d3d1e)return![];if(!_0x3d3d1e[_0x200c8c(0x138)])return!![];if(!_0x314c27)return![];const _0x31ef45=await this[_0x200c8c(0x131)]['getSourceFromJWT'](_0x314c27);if(_0x31ef45[_0x200c8c(0x123)]&&_0x31ef45[_0x200c8c(0x123)][_0x200c8c(0x150)]('admin'))return!![];if(_0x31ef45[_0x200c8c(0x137)][_0x200c8c(0x132)]()===_0x3d3d1e[_0x200c8c(0x192)]['toString']())return!![];const _0x439d8d=await this[_0x200c8c(0x139)][_0x200c8c(0x182)](_0x3d3d1e['_id'],_0x31ef45);if(_0x439d8d)return!![];return![];}};VideoService=__decorate([common_1[a420_0x2b8046(0x184)](),__param(0x0,common_1[a420_0x2b8046(0x14b)](providers_1['PERFORMER_VIDEO_MODEL_PROVIDER'])),__param(0x2,common_1['Inject'](common_1[a420_0x2b8046(0x12e)](()=>services_1[a420_0x2b8046(0x128)]))),__param(0x4,common_1['Inject'](common_1[a420_0x2b8046(0x12e)](()=>services_3[a420_0x2b8046(0x174)]))),__param(0x5,common_1[a420_0x2b8046(0x14b)](common_1[a420_0x2b8046(0x12e)](()=>services_4[a420_0x2b8046(0x12b)]))),__metadata('design:paramtypes',[mongoose_1['Model'],kernel_1[a420_0x2b8046(0x16c)],services_1[a420_0x2b8046(0x128)],services_2[a420_0x2b8046(0x164)],services_3['AuthService'],services_4[a420_0x2b8046(0x12b)]])],VideoService),exports[a420_0x2b8046(0x14f)]=VideoService;