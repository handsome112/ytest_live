'use strict';const a416_0x169e=['getSourceFromJWT','includes','PHOTO_PROCESSED','@nestjs/common','details','../../user/dtos','DELETED','../../../kernel','forwardRef','roles','__decorate','210146XsNaEk','set','error','UPDATED','data','handleDefaultCoverGallery','defineProperty','&token=','galleryService','QueueEventService','remove','ACTIVE','findOne','save','length','487257qeqlPo','processing','EntityNotFoundException','function','FileService','height','4SMRWOx','create','checkAuth','delete','publish','admin','AuthService','findById','updatedBy','UPDATE_DEFAULT_COVER_GALLERY','PaymentTokenService','1850771XmTzfA','FILE_ERROR','../constants','Model','eventName','Injectable','CREATED','title','log','status','../../purchased-item/services','width','queueEventService','PhotoDto','performerService','getUrl','queueProcessPhoto','244513XDkyik','../providers','1531811FwqYOf','object','FILE_RELATED_MODULE_UPDATED','PHOTO_STATUS','isImage','find','704815VLMHmM','fileService','QueueEvent','4oONBGa','fileId','_id','DELETE_FILE_TYPE','performerId','photo','gallery','performer-photo','assign','getOwnPropertyDescriptor','FILE_PROCESSED','toString','mongoose','__param','deleteMany','getThumbnails','../../performer/services','checkBought','paymentTokenService','performer','../../auth/services','design:paramtypes','PurchaseItemType','FILE_EVENT','PhotoService','bind','decorate','../../file','?galleryId=','isSale','deleteManyByIds','merge','../../../kernel/constants','../../purchased-item/constants','meta','subscribe','PHOTO','EVENT','../dtos','username','./gallery.service','addRef','PERFORMER_PHOTO_CHANNEL','galleryId','updateCover','all','Invalid\x20image!','13309RrIlwA','updateInfo','name','handleFileProcessed','Inject','updatedAt','authService','../../file/services','PhotoModel'];const a416_0x542164=a416_0x3937;(function(_0x1197f6,_0xc09a82){const _0x2c5783=a416_0x3937;while(!![]){try{const _0x27d790=parseInt(_0x2c5783(0x195))+parseInt(_0x2c5783(0x182))+-parseInt(_0x2c5783(0x171))+-parseInt(_0x2c5783(0x11c))+-parseInt(_0x2c5783(0x11f))*parseInt(_0x2c5783(0x14e))+parseInt(_0x2c5783(0x177))*-parseInt(_0x2c5783(0x193))+-parseInt(_0x2c5783(0x162));if(_0x27d790===_0xc09a82)break;else _0x1197f6['push'](_0x1197f6['shift']());}catch(_0x29212d){_0x1197f6['push'](_0x1197f6['shift']());}}}(a416_0x169e,0xe7b54));var __decorate=this&&this[a416_0x542164(0x161)]||function(_0x35fd1b,_0x18938d,_0x299e3f,_0x33e5da){const _0x5c7ff7=a416_0x542164;var _0x37fc9b=arguments[_0x5c7ff7(0x170)],_0xbd4520=_0x37fc9b<0x3?_0x18938d:_0x33e5da===null?_0x33e5da=Object[_0x5c7ff7(0x128)](_0x18938d,_0x299e3f):_0x33e5da,_0x415db5;if(typeof Reflect===_0x5c7ff7(0x196)&&typeof Reflect[_0x5c7ff7(0x139)]===_0x5c7ff7(0x174))_0xbd4520=Reflect[_0x5c7ff7(0x139)](_0x35fd1b,_0x18938d,_0x299e3f,_0x33e5da);else{for(var _0x4be541=_0x35fd1b[_0x5c7ff7(0x170)]-0x1;_0x4be541>=0x0;_0x4be541--)if(_0x415db5=_0x35fd1b[_0x4be541])_0xbd4520=(_0x37fc9b<0x3?_0x415db5(_0xbd4520):_0x37fc9b>0x3?_0x415db5(_0x18938d,_0x299e3f,_0xbd4520):_0x415db5(_0x18938d,_0x299e3f))||_0xbd4520;}return _0x37fc9b>0x3&&_0xbd4520&&Object[_0x5c7ff7(0x168)](_0x18938d,_0x299e3f,_0xbd4520),_0xbd4520;},__metadata=this&&this['__metadata']||function(_0x56eba2,_0x2a2fd2){const _0x550c79=a416_0x542164;if(typeof Reflect===_0x550c79(0x196)&&typeof Reflect['metadata']===_0x550c79(0x174))return Reflect['metadata'](_0x56eba2,_0x2a2fd2);},__param=this&&this[a416_0x542164(0x12c)]||function(_0x1132f0,_0x15e6f4){return function(_0x206584,_0x3b2174){_0x15e6f4(_0x206584,_0x3b2174,_0x1132f0);};};function a416_0x3937(_0x1c9ce0,_0x449ec4){return a416_0x3937=function(_0x169e29,_0x393714){_0x169e29=_0x169e29-0x11b;let _0x56c52d=a416_0x169e[_0x169e29];return _0x56c52d;},a416_0x3937(_0x1c9ce0,_0x449ec4);}Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[a416_0x542164(0x137)]=void 0x0;const common_1=require(a416_0x542164(0x15a)),mongoose_1=require(a416_0x542164(0x12b)),kernel_1=require(a416_0x542164(0x15e)),file_1=require(a416_0x542164(0x13a)),dtos_1=require(a416_0x542164(0x15c)),services_1=require(a416_0x542164(0x155)),lodash_1=require('lodash'),services_2=require(a416_0x542164(0x12f)),constants_1=require(a416_0x542164(0x13f)),services_3=require(a416_0x542164(0x18c)),constants_2=require(a416_0x542164(0x140)),services_4=require(a416_0x542164(0x133)),constants_3=require(a416_0x542164(0x184)),dtos_2=require(a416_0x542164(0x145)),gallery_service_1=require(a416_0x542164(0x147)),providers_1=require(a416_0x542164(0x194)),FILE_PROCESSED_TOPIC=a416_0x542164(0x129),UPDATE_DEFAULT_COVER_GALLERY=a416_0x542164(0x180);let PhotoService=class PhotoService{constructor(_0xe876e2,_0x537b0c,_0x5597eb,_0x3987b5,_0x1d8d70,_0x5d58dc,_0x1fec4b){const _0x1ba82f=a416_0x542164;this['PhotoModel']=_0xe876e2,this['queueEventService']=_0x537b0c,this['fileService']=_0x5597eb,this[_0x1ba82f(0x154)]=_0x3987b5,this[_0x1ba82f(0x131)]=_0x1d8d70,this[_0x1ba82f(0x16a)]=_0x5d58dc,this['performerService']=_0x1fec4b,this[_0x1ba82f(0x18e)][_0x1ba82f(0x142)](constants_3[_0x1ba82f(0x149)],FILE_PROCESSED_TOPIC,this[_0x1ba82f(0x151)][_0x1ba82f(0x138)](this)),this[_0x1ba82f(0x18e)]['subscribe'](constants_3['PERFORMER_PHOTO_CHANNEL'],UPDATE_DEFAULT_COVER_GALLERY,this[_0x1ba82f(0x167)][_0x1ba82f(0x138)](this));}async[a416_0x542164(0x11b)](_0x580b35={}){const _0x269a0c=a416_0x542164;return this[_0x269a0c(0x156)]['find'](_0x580b35);}async['handleFileProcessed'](_0x3bb6fe){const _0x18146a=a416_0x542164;try{if(_0x3bb6fe[_0x18146a(0x186)]!==services_1[_0x18146a(0x136)][_0x18146a(0x159)])return;const {photoId:_0x546a4e}=_0x3bb6fe[_0x18146a(0x166)][_0x18146a(0x141)],[_0x39b322,_0xd16e72]=await Promise[_0x18146a(0x14c)]([this[_0x18146a(0x156)][_0x18146a(0x17e)](_0x546a4e),this[_0x18146a(0x11d)][_0x18146a(0x17e)](_0x3bb6fe[_0x18146a(0x166)][_0x18146a(0x120)])]);if(!_0x39b322)return;_0x39b322[_0x18146a(0x172)]=![],_0xd16e72[_0x18146a(0x18b)]===_0x18146a(0x164)&&(_0x39b322['status']=constants_3[_0x18146a(0x198)][_0x18146a(0x183)]),await _0x39b322[_0x18146a(0x16f)]();}catch(_0x5a7a6a){console[_0x18146a(0x18a)](_0x5a7a6a);}}async[a416_0x542164(0x178)](_0x341bdd,_0x44e59e,_0x3103af){const _0x4c2c9c=a416_0x542164;if(!_0x341bdd)throw new Error('File\x20is\x20valid!');if(!_0x341bdd['isImage']()){await this[_0x4c2c9c(0x11d)]['removeIfNotHaveRef'](_0x341bdd['_id']);throw new Error(_0x4c2c9c(0x14d));}const _0x55835e=new this[(_0x4c2c9c(0x156))](_0x44e59e);if(!_0x55835e['title'])_0x55835e[_0x4c2c9c(0x189)]=_0x341bdd[_0x4c2c9c(0x150)];_0x55835e[_0x4c2c9c(0x120)]=_0x341bdd[_0x4c2c9c(0x121)];_0x3103af&&(_0x55835e['createdBy']=_0x3103af[_0x4c2c9c(0x121)],_0x55835e[_0x4c2c9c(0x17f)]=_0x3103af[_0x4c2c9c(0x121)]);_0x55835e[_0x4c2c9c(0x172)]=!![],await _0x55835e[_0x4c2c9c(0x16f)](),await Promise[_0x4c2c9c(0x14c)]([this[_0x4c2c9c(0x11d)][_0x4c2c9c(0x148)](_0x341bdd[_0x4c2c9c(0x121)],{'itemType':_0x4c2c9c(0x126),'itemId':_0x55835e[_0x4c2c9c(0x121)]}),this[_0x4c2c9c(0x11d)][_0x4c2c9c(0x192)](_0x341bdd[_0x4c2c9c(0x121)],{'meta':{'photoId':_0x55835e[_0x4c2c9c(0x121)]},'publishChannel':constants_3[_0x4c2c9c(0x149)],'thumbnailSize':{'width':0xfa,'height':0xfa}})]);const _0x417f05=new dtos_2[(_0x4c2c9c(0x18f))](_0x55835e);return await this[_0x4c2c9c(0x18e)]['publish'](new kernel_1[(_0x4c2c9c(0x11e))]({'channel':constants_3[_0x4c2c9c(0x149)],'eventName':constants_1[_0x4c2c9c(0x144)][_0x4c2c9c(0x188)],'data':_0x417f05})),_0x417f05;}async[a416_0x542164(0x14f)](_0xded93a,_0x5df7ad,_0x3579db,_0x42c769){const _0x406837=a416_0x542164,_0xfd36b2=await this[_0x406837(0x156)][_0x406837(0x17e)](_0xded93a);if(!_0xfd36b2)throw new kernel_1[(_0x406837(0x173))]();const _0x1eaf64=_0xfd36b2[_0x406837(0x18b)],_0x2ddd02=_0xfd36b2[_0x406837(0x14a)],_0x484670=_0xfd36b2['fileId'];if(_0x3579db){if(!_0x3579db[_0x406837(0x199)]){await this[_0x406837(0x11d)]['removeIfNotHaveRef'](_0x3579db['_id']);throw new Error(_0x406837(0x14d));}_0xfd36b2['fileId']=_0x3579db['_id'];}lodash_1[_0x406837(0x13e)](_0xfd36b2,_0x5df7ad);_0xfd36b2[_0x406837(0x18b)]!==constants_3['PHOTO_STATUS'][_0x406837(0x183)]&&_0x5df7ad[_0x406837(0x18b)]!==constants_3['PHOTO_STATUS'][_0x406837(0x183)]&&(_0xfd36b2[_0x406837(0x18b)]=_0x5df7ad[_0x406837(0x18b)]);_0x42c769&&_0xfd36b2[_0x406837(0x163)](_0x406837(0x17f),_0x42c769[_0x406837(0x121)]),_0xfd36b2[_0x406837(0x153)]=new Date(),await _0xfd36b2['save']();_0x3579db&&_0x3579db[_0x406837(0x199)]()&&await Promise['all']([this[_0x406837(0x11d)]['addRef'](_0x3579db[_0x406837(0x121)],{'itemType':_0x406837(0x126),'itemId':_0xfd36b2[_0x406837(0x121)]}),this['fileService']['queueProcessPhoto'](_0x3579db['_id'],{'meta':{'photoId':_0xfd36b2[_0x406837(0x121)]},'publishChannel':constants_3[_0x406837(0x149)],'thumbnailSize':{'width':0xfa,'height':0xfa}}),this[_0x406837(0x18e)][_0x406837(0x17b)](new kernel_1[(_0x406837(0x11e))]({'channel':services_1['MEDIA_FILE_CHANNEL'],'eventName':services_1[_0x406837(0x136)][_0x406837(0x197)],'data':{'type':services_1[_0x406837(0x122)]['FILEID'],'currentFile':_0x484670,'newFile':_0x3579db['_id']}}))]);const _0x22d5ff=new dtos_2[(_0x406837(0x18f))](_0xfd36b2);return this[_0x406837(0x18e)][_0x406837(0x17b)](new kernel_1[(_0x406837(0x11e))]({'channel':constants_3[_0x406837(0x149)],'eventName':constants_1['EVENT'][_0x406837(0x165)],'data':Object[_0x406837(0x127)](Object[_0x406837(0x127)]({},_0x22d5ff),{'oldStatus':_0x1eaf64,'oldGallery':_0x2ddd02})})),_0x22d5ff;}async[a416_0x542164(0x15b)](_0x8f52c1,_0x12487f){const _0x47366a=a416_0x542164,_0x5c20a8=await this[_0x47366a(0x156)][_0x47366a(0x16e)]({'_id':_0x8f52c1});if(!_0x5c20a8)throw new kernel_1[(_0x47366a(0x173))]();const _0xd3b6a0=new dtos_2[(_0x47366a(0x18f))](_0x5c20a8),[_0x4616a3,_0x118c16,_0x41cc44]=await Promise['all']([_0x5c20a8['performerId']?this[_0x47366a(0x190)]['findById'](_0x5c20a8[_0x47366a(0x123)]):null,_0x5c20a8[_0x47366a(0x14a)]?this[_0x47366a(0x16a)][_0x47366a(0x17e)](_0x5c20a8[_0x47366a(0x14a)]):null,_0x5c20a8[_0x47366a(0x120)]?this[_0x47366a(0x11d)]['findById'](_0x5c20a8[_0x47366a(0x120)]):null]);if(_0x4616a3)_0xd3b6a0[_0x47366a(0x132)]={'username':_0x4616a3[_0x47366a(0x146)]};if(_0x118c16)_0xd3b6a0[_0x47366a(0x125)]=new dtos_2['GalleryDto'](_0x118c16);return _0x41cc44&&(_0xd3b6a0[_0x47366a(0x124)]={'url':_0x12487f?_0x41cc44[_0x47366a(0x191)]()+'?galleryId='+_0x5c20a8['galleryId']+_0x47366a(0x169)+_0x12487f:_0x41cc44['getUrl']()+_0x47366a(0x13b)+_0x5c20a8[_0x47366a(0x14a)]+_0x47366a(0x169)+_0x12487f,'thumbnails':_0x41cc44[_0x47366a(0x12e)](),'width':_0x41cc44[_0x47366a(0x18d)],'height':_0x41cc44[_0x47366a(0x176)]}),_0xd3b6a0;}async[a416_0x542164(0x17a)](_0x382862){const _0x40d2ca=a416_0x542164,_0x4e2410=await this[_0x40d2ca(0x156)][_0x40d2ca(0x17e)](_0x382862);if(!_0x4e2410)throw new kernel_1['EntityNotFoundException']();const _0x211954=new dtos_2[(_0x40d2ca(0x18f))](_0x4e2410);return await _0x4e2410[_0x40d2ca(0x16c)](),_0x4e2410[_0x40d2ca(0x120)]&&await this['fileService']['remove'](_0x4e2410[_0x40d2ca(0x120)]),await this[_0x40d2ca(0x18e)][_0x40d2ca(0x17b)](new kernel_1[(_0x40d2ca(0x11e))]({'channel':constants_3['PERFORMER_PHOTO_CHANNEL'],'eventName':constants_1['EVENT'][_0x40d2ca(0x15d)],'data':_0x211954})),!![];}async[a416_0x542164(0x12d)](_0x255fc1){const _0x44a9de=a416_0x542164;return this[_0x44a9de(0x156)][_0x44a9de(0x12d)](_0x255fc1);}[a416_0x542164(0x13d)](_0x561e4a){const _0x23f01a=a416_0x542164;return this[_0x23f01a(0x156)][_0x23f01a(0x12d)]({'_id':{'$in':_0x561e4a}});}async['handleDefaultCoverGallery'](_0x8f75a2){const _0x2014f2=a416_0x542164;if(![constants_1[_0x2014f2(0x144)][_0x2014f2(0x188)],constants_1[_0x2014f2(0x144)][_0x2014f2(0x165)]]['includes'](_0x8f75a2[_0x2014f2(0x186)]))return;const _0x407bc9=_0x8f75a2['data'];if(!_0x407bc9[_0x2014f2(0x14a)])return;const _0x8eef1e=await this['PhotoModel'][_0x2014f2(0x16e)]({'galleryId':_0x407bc9[_0x2014f2(0x14a)],'status':constants_3[_0x2014f2(0x198)][_0x2014f2(0x16d)]});await this['galleryService'][_0x2014f2(0x14b)](_0x407bc9[_0x2014f2(0x14a)],_0x8eef1e?_0x8eef1e[_0x2014f2(0x121)]:null);const _0x30d555=await this[_0x2014f2(0x156)]['findOne']({'galleryId':_0x407bc9[_0x2014f2(0x14a)],'isGalleryCover':!![]});if(!_0x8eef1e||_0x30d555&&_0x30d555[_0x2014f2(0x121)][_0x2014f2(0x12a)]()===_0x8eef1e[_0x2014f2(0x12a)]())return;await this[_0x2014f2(0x156)]['updateOne']({'_id':_0x8eef1e[_0x2014f2(0x121)]},{'isGalleryCover':!![]});}async[a416_0x542164(0x179)](_0x4ac0ec){const _0x1d9242=a416_0x542164,{query:{galleryId:_0x17933e,token:_0x46ac3f}}=_0x4ac0ec,_0x807ce3=_0x17933e&&await this[_0x1d9242(0x16a)][_0x1d9242(0x17e)](_0x17933e);if(!_0x807ce3)return![];if(!_0x807ce3[_0x1d9242(0x13c)])return!![];if(!_0x46ac3f)return![];const _0x240535=await this[_0x1d9242(0x154)][_0x1d9242(0x157)](_0x46ac3f);if(!_0x240535)return![];if(_0x240535['roles']&&_0x240535[_0x1d9242(0x160)][_0x1d9242(0x158)](_0x1d9242(0x17c)))return!![];if(_0x240535['_id'][_0x1d9242(0x12a)]()===_0x807ce3['performerId'][_0x1d9242(0x12a)]())return!![];const _0x31ac98=await this[_0x1d9242(0x131)][_0x1d9242(0x130)](_0x807ce3['_id'],constants_2[_0x1d9242(0x135)][_0x1d9242(0x143)],_0x240535);if(_0x31ac98)return!![];return![];}};PhotoService=__decorate([common_1[a416_0x542164(0x187)](),__param(0x0,common_1[a416_0x542164(0x152)](providers_1['PERFORMER_PHOTO_MODEL_PROVIDER'])),__param(0x2,common_1[a416_0x542164(0x152)](common_1[a416_0x542164(0x15f)](()=>services_1[a416_0x542164(0x175)]))),__param(0x3,common_1[a416_0x542164(0x152)](common_1[a416_0x542164(0x15f)](()=>services_4[a416_0x542164(0x17d)]))),__param(0x4,common_1[a416_0x542164(0x152)](common_1['forwardRef'](()=>services_3[a416_0x542164(0x181)]))),__param(0x5,common_1['Inject'](common_1[a416_0x542164(0x15f)](()=>gallery_service_1['GalleryService']))),__param(0x6,common_1[a416_0x542164(0x152)](common_1[a416_0x542164(0x15f)](()=>services_2['PerformerService']))),__metadata(a416_0x542164(0x134),[mongoose_1[a416_0x542164(0x185)],kernel_1[a416_0x542164(0x16b)],services_1[a416_0x542164(0x175)],services_4[a416_0x542164(0x17d)],services_3[a416_0x542164(0x181)],gallery_service_1['GalleryService'],services_2['PerformerService']])],PhotoService),exports['PhotoService']=PhotoService;