'use strict';const a387_0x40f8=['length','mailService','authService','3792yBVJYV','findBySource','email','?productId=','queueEventService','decorate','PURCHASE_ITEM_TYPE','Inject','productService','findById','eventName','43Vptemu','UPDATE_STOCK_CHANNEL','7rySmyl','username','metadata','data','user','398116EbgLJH','defineProperty','PURCHASED_ITEM_SUCCESS_CHANNEL','sourceId','../../../kernel','@nestjs/common','../../purchased-item/constants','subscribe','23AkCJvl','384kBuqyL','getOwnPropertyDescriptor','CREATED','2165WkZnfa','Digital\x20file','PHYSICAL','QueueEventService','type','__metadata','_id','handleStockProducts','object','../../mailer/services','&token=','generateJWT','761157fopNRb','85454TdxSug','../constants','targetId','PRODUCT_TYPE','includes','__decorate','bind','EVENT','__param','PRODUCT','updateStock','../../auth/services','9623OCxCqv','../../file','lodash','826352ZpJdna','FileDto','StockProductListener','ProductService','Injectable','fileService','pick','AuthService'];function a387_0x2c7b(_0x4183d5,_0xc49e42){return a387_0x2c7b=function(_0x40f8e6,_0x2c7b68){_0x40f8e6=_0x40f8e6-0x1bc;let _0x44cbf2=a387_0x40f8[_0x40f8e6];return _0x44cbf2;},a387_0x2c7b(_0x4183d5,_0xc49e42);}const a387_0x1ed55c=a387_0x2c7b;(function(_0x56f9aa,_0x3fdf9a){const _0x26539b=a387_0x2c7b;while(!![]){try{const _0x33da21=parseInt(_0x26539b(0x1dd))+-parseInt(_0x26539b(0x1e6))*parseInt(_0x26539b(0x1e9))+parseInt(_0x26539b(0x1f5))+parseInt(_0x26539b(0x1d6))*parseInt(_0x26539b(0x1bd))+-parseInt(_0x26539b(0x1cb))*parseInt(_0x26539b(0x1e5))+-parseInt(_0x26539b(0x1c0))+-parseInt(_0x26539b(0x1d8))*-parseInt(_0x26539b(0x1f6));if(_0x33da21===_0x3fdf9a)break;else _0x56f9aa['push'](_0x56f9aa['shift']());}catch(_0x1f9c4a){_0x56f9aa['push'](_0x56f9aa['shift']());}}}(a387_0x40f8,0x68148));var __decorate=this&&this[a387_0x1ed55c(0x1fb)]||function(_0x1a31f7,_0x1f3d24,_0x830d1c,_0x2e80b9){const _0x5dad85=a387_0x1ed55c;var _0xb38189=arguments[_0x5dad85(0x1c8)],_0x2fe9ef=_0xb38189<0x3?_0x1f3d24:_0x2e80b9===null?_0x2e80b9=Object[_0x5dad85(0x1e7)](_0x1f3d24,_0x830d1c):_0x2e80b9,_0x3a5701;if(typeof Reflect==='object'&&typeof Reflect[_0x5dad85(0x1d0)]==='function')_0x2fe9ef=Reflect['decorate'](_0x1a31f7,_0x1f3d24,_0x830d1c,_0x2e80b9);else{for(var _0x68d4c5=_0x1a31f7[_0x5dad85(0x1c8)]-0x1;_0x68d4c5>=0x0;_0x68d4c5--)if(_0x3a5701=_0x1a31f7[_0x68d4c5])_0x2fe9ef=(_0xb38189<0x3?_0x3a5701(_0x2fe9ef):_0xb38189>0x3?_0x3a5701(_0x1f3d24,_0x830d1c,_0x2fe9ef):_0x3a5701(_0x1f3d24,_0x830d1c))||_0x2fe9ef;}return _0xb38189>0x3&&_0x2fe9ef&&Object[_0x5dad85(0x1de)](_0x1f3d24,_0x830d1c,_0x2fe9ef),_0x2fe9ef;},__metadata=this&&this[a387_0x1ed55c(0x1ee)]||function(_0x414a4e,_0x5b171d){const _0x215250=a387_0x1ed55c;if(typeof Reflect===_0x215250(0x1f1)&&typeof Reflect[_0x215250(0x1da)]==='function')return Reflect[_0x215250(0x1da)](_0x414a4e,_0x5b171d);},__param=this&&this[a387_0x1ed55c(0x1fe)]||function(_0x558095,_0x38457b){return function(_0x336610,_0x44f9ae){_0x38457b(_0x336610,_0x44f9ae,_0x558095);};};Object[a387_0x1ed55c(0x1de)](exports,'__esModule',{'value':!![]}),exports['StockProductListener']=void 0x0;const common_1=require(a387_0x1ed55c(0x1e2)),kernel_1=require(a387_0x1ed55c(0x1e1)),constants_1=require(a387_0x1ed55c(0x1e3)),file_1=require(a387_0x1ed55c(0x1be)),services_1=require('../../file/services'),constants_2=require('../../../kernel/constants'),services_2=require(a387_0x1ed55c(0x1f2)),services_3=require(a387_0x1ed55c(0x1bc)),lodash_1=require(a387_0x1ed55c(0x1bf)),constants_3=require('../../purchased-item/constants'),services_4=require('../services'),constants_4=require(a387_0x1ed55c(0x1f7)),UPDATE_STOCK_CHANNEL=a387_0x1ed55c(0x1d7);let StockProductListener=class StockProductListener{constructor(_0x2f27d1,_0x425a9c,_0x4c1038,_0x5a28bd,_0x26bfa5){const _0x5000b7=a387_0x1ed55c;this[_0x5000b7(0x1ca)]=_0x2f27d1,this['queueEventService']=_0x425a9c,this['productService']=_0x4c1038,this[_0x5000b7(0x1c5)]=_0x5a28bd,this['mailService']=_0x26bfa5,this[_0x5000b7(0x1cf)][_0x5000b7(0x1e4)](constants_1[_0x5000b7(0x1df)],UPDATE_STOCK_CHANNEL,this[_0x5000b7(0x1f0)][_0x5000b7(0x1fc)](this));}async['handleStockProducts'](_0x3e8012){const _0x4f787b=a387_0x1ed55c,_0x2c1695=_0x3e8012[_0x4f787b(0x1db)];if(![constants_2[_0x4f787b(0x1fd)][_0x4f787b(0x1e8)]][_0x4f787b(0x1fa)](_0x3e8012[_0x4f787b(0x1d5)])||(_0x2c1695===null||_0x2c1695===void 0x0?void 0x0:_0x2c1695[_0x4f787b(0x1ed)])!==constants_3[_0x4f787b(0x1d1)][_0x4f787b(0x1ff)])return;const _0x3617af=await this['productService'][_0x4f787b(0x1d4)](_0x2c1695[_0x4f787b(0x1f8)]);if((_0x3617af===null||_0x3617af===void 0x0?void 0x0:_0x3617af[_0x4f787b(0x1ed)])!==constants_4[_0x4f787b(0x1f9)][_0x4f787b(0x1eb)])return;await this[_0x4f787b(0x1d3)][_0x4f787b(0x200)](_0x2c1695[_0x4f787b(0x1f8)],-0x1);}async['sendDigitalProductLink'](_0x33b5fd,_0x5a5fe8,_0x1b72f3,_0x5a72c9){const _0x21f5fd=a387_0x1ed55c,_0x345780=await this[_0x21f5fd(0x1ca)][_0x21f5fd(0x1cc)]({'source':_0x21f5fd(0x1dc),'type':'email','sourceId':_0x33b5fd[_0x21f5fd(0x1e0)]})||await this[_0x21f5fd(0x1ca)][_0x21f5fd(0x1cc)]({'source':'user','type':_0x21f5fd(0x1d9),'sourceId':_0x33b5fd[_0x21f5fd(0x1e0)]}),_0x1cf858=this[_0x21f5fd(0x1ca)][_0x21f5fd(0x1f4)](lodash_1[_0x21f5fd(0x1c6)](_0x345780,[_0x21f5fd(0x1ef),'source',_0x21f5fd(0x1e0)]),{'expiresIn':0x3*0x3c*0x3c}),_0x425fb8=await this[_0x21f5fd(0x1c5)][_0x21f5fd(0x1d4)](_0x5a72c9);if(_0x425fb8){const _0x4f9050=_0x1cf858?new file_1['FileDto'](_0x425fb8)['getUrl']()+_0x21f5fd(0x1ce)+_0x33b5fd[_0x21f5fd(0x1f8)]+_0x21f5fd(0x1f3)+_0x1cf858:new file_1[(_0x21f5fd(0x1c1))](_0x425fb8)['getUrl']()+'?productId='+_0x33b5fd[_0x21f5fd(0x1f8)];await this[_0x21f5fd(0x1c9)]['send']({'subject':_0x21f5fd(0x1ea),'to':_0x1b72f3[_0x21f5fd(0x1cd)],'data':{'performer':_0x5a5fe8,'user':_0x1b72f3,'transaction':_0x33b5fd,'digitalLink':_0x4f9050},'template':'send-user-digital-product'});}}};StockProductListener=__decorate([common_1[a387_0x1ed55c(0x1c4)](),__param(0x0,common_1[a387_0x1ed55c(0x1d2)](common_1['forwardRef'](()=>services_3['AuthService']))),__metadata('design:paramtypes',[services_3[a387_0x1ed55c(0x1c7)],kernel_1[a387_0x1ed55c(0x1ec)],services_4[a387_0x1ed55c(0x1c3)],services_1['FileService'],services_2['MailerService']])],StockProductListener),exports[a387_0x1ed55c(0x1c2)]=StockProductListener;